<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras - ERP System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos para el modal de factura */
        #facturaSimpleModal {
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        
        #facturaSimpleModal:not(.hidden) {
            display: flex !important;
            opacity: 1 !important;
        }
        
        #facturaSimpleModal > div {
            background: white;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 90%;
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transform: none;
            opacity: 1;
        }
        
        #facturaSimpleModal > div.opacity-100 {
            opacity: 1;
            transform: scale(1);
        }
        
        #facturaSimpleModal {
            display: none; /* Inicialmente oculto */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        #facturaSimpleModal:not(.hidden) {
            display: flex;
        }
        
        #facturaSimpleModal > div {
            background: white;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 64rem;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .purchase-table th {
            @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .purchase-table td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-500;
        }
        .status-pending {
            @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800;
        }
        .status-received {
            @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800;
        }
        .status-cancelled {
            @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800;
        }
        .status-delayed {
            @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 animate-pulse;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-white text-gray-700 px-4 py-2 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <div id="navbar"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Módulo de Compras</h1>
                <p class="text-gray-600">Gestiona tus órdenes de compra y facturas de proveedores</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="document.getElementById('facturaSimpleModal').classList.remove('hidden'); document.body.style.overflow = 'hidden';" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center gap-2">
                    <i class="fas fa-file-invoice"></i>
                    <span>Nueva Factura</span>
                </button>
                <button onclick="showDebugInfo()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md flex items-center gap-2">
                    <i class="fas fa-bug"></i>
                    <span>Depuración</span>
                </button>
            </div>
        </div>

    </div> <!-- Close container from line 42 -->
    
    <!-- Purchases Content -->
    <div class="container mx-auto px-4">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <!-- Total de Órdenes -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                <div class="p-5">
                    <div class="flex items-center justify-between">
                        <div class="p-3 rounded-lg bg-gray-50 text-gray-500">
                            <i class="fas fa-shopping-cart text-xl"></i>
                        </div>
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-600">0%</span>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-500">Órdenes del Mes</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        <div class="mt-2 flex items-center text-xs text-gray-500">
                            <span class="text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span>Sin datos de meses anteriores</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Órdenes Recibidas -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                <div class="p-5">
                    <div class="flex items-center justify-between">
                        <div class="p-3 rounded-lg bg-gray-50 text-gray-400">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-500">0%</span>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-500">Órdenes Recibidas</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1">
                                <div class="bg-gray-300 h-1.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Completado</span>
                                <span>0/0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Órdenes Pendientes -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                <div class="p-5">
                    <div class="flex items-center justify-between">
                        <div class="p-3 rounded-lg bg-gray-50 text-gray-400">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-500">0 vencidas</span>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-500">Órdenes Pendientes</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        <div class="mt-2">
                            <div class="flex items-center">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                        <span>Vencidas</span>
                                        <span>0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-gray-300 h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-xs text-gray-500">
                                <span class="text-gray-400">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    <span>Sin órdenes pendientes</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gasto Mensual -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                <div class="p-5">
                    <div class="flex items-center justify-between">
                        <div class="p-3 rounded-lg bg-gray-50 text-gray-400">
                            <i class="fas fa-dollar-sign text-xl"></i>
                        </div>
                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-500">0%</span>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-500">Gasto Mensual</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1">$0.00</h3>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="bg-gray-300 h-1.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="mt-2 flex items-center text-xs text-gray-500">
                                <span class="text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span>Sin movimientos este mes</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <!-- Tabs and Search/Filter Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                    <!-- Tabs -->
                    <div class="border-b border-gray-100">
                        <nav class="flex overflow-x-auto hide-scrollbar">
                            <button class="border-b-2 border-indigo-500 text-indigo-600 px-6 py-4 text-sm font-medium whitespace-nowrap">
                                <i class="fas fa-list-ul mr-2"></i>Todas las Órdenes
                            </button>
                            <button class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200 px-6 py-4 text-sm font-medium whitespace-nowrap">
                                <i class="far fa-clock mr-2"></i>Pendientes
                            </button>
                            <button class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200 px-6 py-4 text-sm font-medium whitespace-nowrap">
                                <i class="fas fa-check-circle mr-2"></i>Completadas
                            </button>
                            <button class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200 px-6 py-4 text-sm font-medium whitespace-nowrap">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Vencidas
                            </button>
                            <button class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-200 px-6 py-4 text-sm font-medium whitespace-nowrap">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>Facturas
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Search Bar -->
                            <div class="relative flex-1 max-w-xl">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="search-orders" 
                                    class="block w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all duration-200" 
                                    placeholder="Buscar órdenes por número, proveedor o referencia...">
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="relative w-full md:w-48">
                                <select id="filter-status" 
                                    class="block w-full pl-3 pr-10 py-2.5 text-base border border-gray-200 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 appearance-none">
                                    <option value="all">Todos los estados</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="received">Recibido</option>
                                    <option value="partial">Parcial</option>
                                    <option value="cancelled">Cancelado</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                            <button class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Purchases Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-12">
                                        <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <div class="flex items-center">
                                            <span># Orden</span>
                                            <button class="ml-1 text-gray-400 hover:text-gray-500">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <div class="flex items-center">
                                            <span>Proveedor</span>
                                            <button class="ml-1 text-gray-400 hover:text-gray-500">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <div class="flex items-center">
                                            <span>Fecha</span>
                                            <button class="ml-1 text-gray-400 hover:text-gray-500">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <div class="flex items-center">
                                            <span>Entrega</span>
                                            <button class="ml-1 text-gray-400 hover:text-gray-500">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <div class="flex items-center justify-end">
                                            <span>Total</span>
                                            <button class="ml-1 text-gray-400 hover:text-gray-500">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        Estado
                                    </th>
                                    <th scope="col" class="relative px-6 py-3.5 w-24">
                                        <span class="sr-only">Acciones</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="listaFacturas" class="bg-white divide-y divide-gray-100">
                                <!-- Example Row 1 -->
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-8 w-8 bg-indigo-50 rounded-md flex items-center justify-center mr-3">
                                                <i class="fas fa-file-invoice text-indigo-600"></i>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">OC-2023-045</div>
                                                <div class="text-xs text-gray-500">Hoy, 10:30 AM</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">Distribuidora Tech</div>
                                        <div class="text-xs text-gray-500">Compras de tecnología</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">15 Sep 2023</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-900">20 Sep 2023</span>
                                            <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                                                5 días
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$1,245.50</div>
                                        <div class="text-xs text-gray-500">3 artículos</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2.5 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                            En proceso
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex items-center justify-end space-x-2">
                                            <button class="text-gray-400 hover:text-indigo-600 transition-colors" title="Ver detalles">
                                                <i class="far fa-eye"></i>
                                            </button>
                                            <button class="text-gray-400 hover:text-blue-600 transition-colors" title="Editar">
                                                <i class="far fa-edit"></i>
                                            </button>
                                            <div class="relative" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-400 hover:text-gray-600 transition-colors">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div x-show="open" @click.away="open = false" 
                                                    class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10" 
                                                    style="display: none;">
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-print mr-2 text-gray-500"></i>Imprimir
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-file-pdf mr-2 text-red-500"></i>Exportar PDF
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                                        <i class="fas fa-trash-alt mr-2"></i>Eliminar
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Example Row 2 (Overdue) -->
                                <tr class="bg-red-50 hover:bg-red-100 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-8 w-8 bg-red-50 rounded-md flex items-center justify-center mr-3">
                                                <i class="fas fa-exclamation-triangle text-red-500"></i>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">OC-2023-044</div>
                                                <div class="text-xs text-gray-500">Hace 2 días</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">Suministros Industriales S.A.</div>
                                        <div class="text-xs text-gray-500">Herramientas y equipo</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">10 Sep 2023</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="text-sm text-red-600 font-medium">12 Sep 2023</span>
                                            <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded-full">
                                                Vencida
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$3,785.00</div>
                                        <div class="text-xs text-gray-500">8 artículos</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2.5 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                            Vencida
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex items-center justify-end space-x-2">
                                            <button class="text-gray-400 hover:text-indigo-600 transition-colors" title="Ver detalles">
                                                <i class="far fa-eye"></i>
                                            </button>
                                            <button class="text-gray-400 hover:text-blue-600 transition-colors" title="Marcar como recibida">
                                                <i class="fas fa-check-circle"></i>
                                            </button>
                                            <div class="relative" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-400 hover:text-gray-600 transition-colors">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div x-show="open" @click.away="open = false" 
                                                    class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10" 
                                                    style="display: none;">
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-print mr-2 text-gray-500"></i>Imprimir
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-file-pdf mr-2 text-red-500"></i>Exportar PDF
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                                        <i class="fas fa-trash-alt mr-2"></i>Eliminar
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Example Row 3 (Completed) -->
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-8 w-8 bg-green-50 rounded-md flex items-center justify-center mr-3">
                                                <i class="fas fa-check-circle text-green-500"></i>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">OC-2023-043</div>
                                                <div class="text-xs text-gray-500">Ayer, 15:45</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">Papelería Creativa</div>
                                        <div class="text-xs text-gray-500">Material de oficina</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">14 Sep 2023</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-900">14 Sep 2023</span>
                                            <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                                                Entregado
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$845.25</div>
                                        <div class="text-xs text-gray-500">12 artículos</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="px-2.5 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                            Completada
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex items-center justify-end space-x-2">
                                            <button class="text-gray-400 hover:text-indigo-600 transition-colors" title="Ver detalles">
                                                <i class="far fa-eye"></i>
                                            </button>
                                            <button class="text-gray-400 hover:text-blue-600 transition-colors" title="Ver factura">
                                                <i class="fas fa-file-invoice"></i>
                                            </button>
                                            <div class="relative" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-400 hover:text-gray-600 transition-colors">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div x-show="open" @click.away="open = false" 
                                                    class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10" 
                                                    style="display: none;">
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-print mr-2 text-gray-500"></i>Imprimir
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-file-pdf mr-2 text-red-500"></i>Exportar PDF
                                                    </a>
                                                    <a href="#" class="block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50">
                                                        <i class="fas fa-redo mr-2"></i>Reabrir orden
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Table Summary and Actions -->
                    <div class="bg-white px-6 py-4 border-t border-gray-100 flex flex-col sm:flex-row items-center justify-between">
                        <div class="text-sm text-gray-500 mb-4 sm:mb-0">
                            <span class="font-medium text-gray-700">0</span> órdenes mostradas
                            <span class="mx-2">•</span>
                            <span>Total: <span class="font-medium text-gray-700">$0.00</span></span>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center text-sm text-gray-500">
                                <span>Filas por página:</span>
                                <select class="ml-2 border-gray-200 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>10</option>
                                    <option>25</option>
                                    <option>50</option>
                                    <option>100</option>
                                </select>
                            </div>
                            
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-400 hover:bg-gray-50 disabled:opacity-50" disabled>
                                    <span class="sr-only">Anterior</span>
                                    <i class="fas fa-chevron-left h-4 w-4"></i>
                                </button>
                                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    1
                                </button>
                                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100">
                                    2
                                </button>
                                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    3
                                </button>
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    ...
                                </span>
                                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    8
                                </button>
                                <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Siguiente</span>
                                    <i class="fas fa-chevron-right h-4 w-4"></i>
                                </button>
                            </nav>
                            
                            <div class="text-sm text-gray-500">
                                <span class="font-medium text-gray-700">1-3</span> de <span class="font-medium text-gray-700">24</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Pagination -->
                    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:hidden">
                        <div class="flex-1 flex justify-between">
                            <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Anterior
                            </button>
                            <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Siguiente
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="newOrderModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">Nueva Orden de Compra</h3>
                            <div class="mt-2">
                                <form id="purchaseOrderForm" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="supplier" class="block text-sm font-medium text-gray-700">Proveedor</label>
                                            <select id="supplier" name="supplier" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <option value="">Seleccionar proveedor</option>
                                            </select>
                                        </div>
                                        <div class="mb-4">
                                            <label for="fechaFactura" class="block text-gray-700 text-sm font-bold mb-2">
                                                Fecha de la factura
                                            </label>
                                            <div class="relative">
                                                <input type="date" id="fechaFactura" name="fechaFactura" 
                                                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                                       value="">
                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                    <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                            </div>
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            const dateInput = document.getElementById('fechaFactura');
            if (dateInput) {
                dateInput.value = formattedDate;
                // Remove any read-only or disabled attributes
                dateInput.removeAttribute('readonly');
                dateInput.removeAttribute('disabled');
            }
        });
    </script>
                                                    const month = String(now.getMonth() + 1).padStart(2, '0');
                                                    const day = String(now.getDate()).padStart(2, '0');
                                                    const today = `${year}-${month}-${day}`;
                                                    const fechaInput = document.getElementById('fechaFactura');
                                                    if (fechaInput) {
                                                        fechaInput.value = today;
                                                        fechaInput.setAttribute('value', today);
                                                    }
                                                });
                                            </script>
                                        </div>
                                        <div>
                                            <label for="expectedDate" class="block text-sm font-medium text-gray-700">Fecha Esperada</label>
                                            <input type="date" id="expectedDate" name="expectedDate" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="warehouse" class="block text-sm font-medium text-gray-700">Almacén</label>
                                            <select id="warehouse" name="warehouse" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <option value="1">Almacén Principal</option>
                                                <option value="2">Almacén Secundario</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4 class="text-sm font-medium text-gray-700 mb-2">Productos</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                                        <th scope="col" class="relative px-6 py-3">
                                                            <span class="sr-only">Acciones</span>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody id="productItems" class="bg-white divide-y divide-gray-200">
                                                    <!-- Product rows will be added here -->
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td colspan="5" class="px-6 py-2">
                                                            <button type="button" onclick="addProductRow()" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
                                                                + Agregar producto
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="3" class="px-6 py-2 text-right text-sm font-medium text-gray-500">Subtotal:</td>
                                                        <td class="px-6 py-2 text-right text-sm font-medium text-gray-900">$<span id="subtotal">0.00</span></td>
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="3" class="px-6 py-2 text-right text-sm font-medium text-gray-500">IVA (16%):</td>
                                                        <td class="px-6 py-2 text-right text-sm font-medium text-gray-900">$<span id="tax">0.00</span></td>
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="3" class="px-6 py-2 text-right text-sm font-bold text-gray-900">Total:</td>
                                                        <td class="px-6 py-2 text-right text-sm font-bold text-gray-900">$<span id="total">0.00</span></td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notas</label>
                                        <textarea id="notes" name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Guardar Orden
                    </button>
                    <button type="button" onclick="closeNewOrderModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug function to check inventory products
        function debugInventoryProducts() {
            console.log('=== DEBUG INVENTORY PRODUCTS ===');
            try {
                const inventoryProducts = localStorage.getItem('inventoryProducts');
                console.log('Raw inventory data:', inventoryProducts);
                if (inventoryProducts) {
                    const products = JSON.parse(inventoryProducts);
                    console.log('Parsed products:', products);
                    console.log('Number of products:', products.length);
                    console.log('First 5 products:', products.slice(0, 5));
                } else {
                    console.log('No inventory products found in localStorage');
                }
            } catch (error) {
                console.error('Error debugging inventory:', error);
            }
        }

        // Debug function to check localStorage contents
        function debugLocalStorage() {
            console.log('=== LOCAL STORAGE DEBUG ===');
            console.log('All localStorage keys:', Object.keys(localStorage));
            
            // Check for inventory products
            const inventoryProducts = localStorage.getItem('inventoryProducts');
            console.log('inventoryProducts exists:', !!inventoryProducts);
            if (inventoryProducts) {
                try {
                    const parsed = JSON.parse(inventoryProducts);
                    console.log('inventoryProducts sample:', Array.isArray(parsed) ? parsed.slice(0, 3) : parsed);
                } catch (e) {
                    console.error('Error parsing inventoryProducts:', e);
                }
            }
            
            // Check for price list products
            const priceListKeys = ['priceListProducts', 'listaPrecios', 'productosPrecio'];
            priceListKeys.forEach(key => {
                const data = localStorage.getItem(key);
                console.log(`${key} exists:`, !!data);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        console.log(`${key} sample:`, Array.isArray(parsed) ? parsed.slice(0, 2) : parsed);
                    } catch (e) {
                        console.error(`Error parsing ${key}:`, e);
                    }
                }
            });
            
            // Check regular products
            const products = localStorage.getItem('products');
            console.log('products exists:', !!products);
            if (products) {
                try {
                    const parsed = JSON.parse(products);
                    console.log('products sample:', Array.isArray(parsed) ? parsed.slice(0, 3) : parsed);
                } catch (e) {
                    console.error('Error parsing products:', e);
                }
            }
            
            console.log('=== END LOCAL STORAGE DEBUG ===');
        }
        
        // Función deshabilitada para no cargar datos de prueba
        function initializeTestData() {
            console.log('=== INICIALIZACIÓN DE DATOS DE PRUEBA DESHABILITADA ===');
            // No hacer nada para mantener el módulo vacío
            
            // Forzar localStorage vacío para órdenes de compra
            localStorage.removeItem('purchaseOrders');
            
            // Actualizar la UI para mostrar estado vacío
            if (typeof actualizarListaOrdenes === 'function') {
                actualizarListaOrdenes();
            }
        }
        
        // Function to show debug information in a modal
        function showDebugInfo() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Get current products from localStorage
            let products = [];
            try {
                const productsData = localStorage.getItem('inventoryProducts') || 
                                   localStorage.getItem('products') ||
                                   '[]';
                products = JSON.parse(productsData);
            } catch (e) {
                console.error('Error parsing products:', e);
            }
            
            // Create modal content
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium">Información de Depuración</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-medium mb-2">Productos en el Sistema (${products.length})</h4>
                        <div class="bg-gray-100 p-3 rounded max-h-60 overflow-y-auto">
                            ${products.length > 0 
                                ? `<pre class="text-xs">${JSON.stringify(products, null, 2)}</pre>`
                                : '<p class="text-gray-500">No hay productos en el sistema</p>'
                            }
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="localStorage.clear(); location.reload()" 
                                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                            Limpiar Datos
                        </button>
                        <button onclick="initializeTestData()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Agregar Productos de Prueba
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Make function globally available
        window.showDebugInfo = showDebugInfo;
        
        // Limpiar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando módulo de compras...');
            
            // Limpiar datos de prueba existentes
            localStorage.removeItem('purchaseOrders');
            localStorage.removeItem('facturas');
            
            // Limpiar datos de depuración
            debugInventoryProducts();
            debugLocalStorage();
            
            console.log('Módulo de compras listo, sin datos de prueba.');
        });

        // Show new order modal
        function showNewOrderModal() {
            const modal = document.getElementById('newOrderModal');
            if (modal) {
                // Reset form
                document.getElementById('purchaseOrderForm').reset();
                // Clear product rows
                const tbody = document.getElementById('productItems');
                if (tbody) tbody.innerHTML = '';
                // Add first product row
                addProductRow();
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('orderDate').value = today;
                // Set expected date to 7 days from now
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('expectedDate').value = nextWeek.toISOString().split('T')[0];
                // Load suppliers
                loadSuppliers();
                // Show modal
                modal.classList.remove('hidden');
            }
        }

        // Close modal
        function closeNewOrderModal() {
            const modal = document.getElementById('newOrderModal');
            if (modal) modal.classList.add('hidden');
        }

        // Debug database initialization
        console.log('Database object:', window.db);
        if (window.db) {
            console.log('Database methods:', Object.keys(window.db));
            console.log('Sample products:', window.db.getProductos ? window.db.getProductos() : 'getProductos method not found');
        }
        
        // Add product row
        function addProductRow() {
            const tbody = document.getElementById('productItems');
            if (!tbody) return;
            
            const row = document.createElement('tr');
            row.className = 'product-row';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <select class="product-select border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border p-2" onchange="updateProductInfo(this)" required>
                        <option value="">Seleccionar producto del inventario</option>
                    </select>
                    <div class="mt-1 text-xs text-gray-500">
                        <span>Disponibles: </span>
                        <span class="stock-display font-medium">0</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="number" min="1" value="1" class="quantity border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border p-2" onchange="updateRowTotal(this)" data-type="quantity" required>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" step="0.01" min="0" value="0.00" class="price pl-7 pr-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm" onchange="updateRowTotal(this)" data-type="price" required>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900 row-total">
                    $0.00
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button type="button" class="text-red-600 hover:text-red-900" onclick="removeProductRow(this)" title="Eliminar producto">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Load products into the select
            const select = row.querySelector('.product-select');
            if (select) {
                loadProducts(select);
            }
            
            updateOrderTotal();
        }

        // Update row total when quantity or price changes
        function updateRowTotal(input) {
            console.log('Actualizando total de fila...');
            const row = input.closest('tr');
            if (!row) {
                console.warn('No se pudo encontrar la fila del producto');
                return;
            }
            
            const priceInput = row.querySelector('input[data-type="price"]');
            const quantityInput = row.querySelector('input[data-type="quantity"]');
            const subtotalCell = row.querySelector('.subtotal');
            
            if (!priceInput || !quantityInput || !subtotalCell) {
                console.warn('No se encontraron todos los elementos necesarios en la fila:', {
                    priceInput: !!priceInput,
                    quantityInput: !!quantityInput,
                    subtotalCell: !!subtotalCell
                });
                return;
            }
            
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const subtotal = price * quantity;
            
            console.log('Calculando subtotal:', { price, quantity, subtotal });
            
            // Actualizar el subtotal en la celda
            subtotalCell.textContent = formatearMoneda(subtotal);
            
            // Actualizar el atributo de datos para el subtotal
            row.dataset.subtotal = subtotal.toFixed(2);
            
            // Actualizar totales generales
            calcularTotales();
        }

        // Update order total
        // Función para actualizar el total de la orden
        function updateOrderTotal() {
            const rows = document.querySelectorAll('.product-row');
            let subtotal = 0;
            let hasErrors = false;
            
            // Calcular subtotal sumando todos los productos
            rows.forEach(row => {
                // Verificar si hay errores de validación en la fila
                const hasWarning = row.querySelector('.stock-warning') !== null;
                if (hasWarning) {
                    hasErrors = true;
                }
                
                // Obtener el total de la fila actual
                const totalText = row.querySelector('.row-total')?.textContent || '$0.00';
                const total = parseFloat(totalText.replace(/[^0-9.-]+/g, '')) || 0;
                subtotal += total;
            });
            
            // Calcular IVA según la opción seleccionada
            const aplicarIva = document.getElementById('aplicarIva')?.checked ?? true;
            const iva = aplicarIva ? subtotal * 0.16 : 0; // 16% IVA si está activado
            const total = subtotal + iva;
            
            // Actualizar la interfaz con los nuevos valores
            const subtotalElement = document.getElementById('subtotal');
            const ivaElement = document.getElementById('iva');
            const totalElement = document.getElementById('total');
            
            if (subtotalElement) subtotalElement.textContent = subtotal.toFixed(2);
            if (ivaElement) ivaElement.textContent = iva.toFixed(2);
            if (totalElement) totalElement.textContent = total.toFixed(2);
            
            // Actualizar el estado del botón de guardar según la validación
            const saveButton = document.querySelector('#facturaSimpleForm button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = hasErrors;
                saveButton.classList.toggle('opacity-50', hasErrors);
                saveButton.classList.toggle('cursor-not-allowed', hasErrors);
                saveButton.title = hasErrors ? 'Corrija los errores antes de guardar' : '';
            }
            
            return !hasErrors; // Retorna true si no hay errores
        }

        // Remove product row
        function removeProductRow(button) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
                updateOrderTotal();
            }
        }

        // Load products from inventory into the select element
        function loadProducts(selectElement) {
            try {
                console.log('Loading products...');
                // Check if database is initialized
                if (!window.db) {
                    console.error('Database is not initialized');
                    return false;
                }
                
                // Clear existing options except the first one (the default/placeholder)
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }

                // Get all products from the database
                console.log('Fetching products from database...');
                const productos = window.db.getProductos();
                console.log('Products from database:', productos);
                
                if (!productos || !Array.isArray(productos) || productos.length === 0) {
                    console.warn('No products found in the database');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No hay productos en el inventario';
                    option.disabled = true;
                    option.selected = true;
                    selectElement.appendChild(option);
                    return false;
                }
                
                // Add each product to the select element
                productos.forEach(producto => {
                    if (producto && producto.id && producto.nombre) {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = `${producto.codigo || ''} - ${producto.nombre} (Disponibles: ${producto.stock || 0})`;
                        selectElement.appendChild(option);
                    }
                });

                // If no products found, add a disabled option
                if (selectElement.options.length === 1) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No hay productos en el inventario';
                    option.disabled = true;
                    option.selected = true;
                    selectElement.appendChild(option);
                }

                // Add event listener to update product info when selection changes
                selectElement.addEventListener('change', function() {
                    updateProductInfo(this);
                });

                return true;
            } catch (error) {
                console.error('Error loading products:', error);
                return false;
            }
        }

        // Update product info when selected
        function updateProductInfo(select) {
            
            // Get product details from localStorage - check both inventory and regular products
            let products = [];
            try {
                // Try to get from inventory first
                const inventoryProducts = localStorage.getItem('inventoryProducts');
                if (inventoryProducts) {
                    products = JSON.parse(inventoryProducts);
                } else {
                    // Fallback to regular products
                    const productsJson = localStorage.getItem('products');
                    if (productsJson) {
                        products = JSON.parse(productsJson);
                    }
                }
            } catch (error) {
                console.error('Error loading products:', error);
                return;
            }
            
            // Find product by ID or codigo
            const product = products.find(p => (p.id === productId || p.codigo === productId));
            if (!product) return;
            
            // Update price field - use price or precio property
            const priceInput = row.querySelector('.price');
            if (priceInput) {
                const price = product.price || product.precio || '0.00';
                priceInput.value = parseFloat(price).toFixed(2);
                
                // Also update quantity to 1 when selecting a new product
                const quantityInput = row.querySelector('.quantity');
                if (quantityInput && quantityInput.value === '0') {
                    quantityInput.value = '1';
                }
                
                // Trigger change event to update total
                const event = new Event('change');
                priceInput.dispatchEvent(event);
            }
        }
    </script>

    <!-- Modal de Selección de Proveedores -->
    <div id="supplierSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-semibold">
                    <i class="fas fa-users mr-2"></i>
                    Seleccionar Proveedor
                </h3>
                <button onclick="closeSupplierSelectionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 border-b">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="supplierSearch" 
                        class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Buscar proveedor..."
                        onkeyup="filterSuppliers()">
                </div>
            </div>
            
            <div class="overflow-y-auto flex-1">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th class="relative px-6 py-3"><span class="sr-only">Seleccionar</span></th>
                        </tr>
                    </thead>
                    <tbody id="supplierList" class="bg-white divide-y divide-gray-200">
                        <!-- Proveedores se cargarán aquí -->
                    </tbody>
                </table>
            </div>
            
            <div class="p-4 border-t flex justify-end space-x-3">
                <button type="button" onclick="closeSupplierSelectionModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mostrar modal de selección de proveedores
        function showSupplierSelectionModal() {
            const modal = document.getElementById('supplierSelectionModal');
            if (!modal) return;
            
            // Cargar la lista de proveedores
            loadSupplierList();
            
            // Mostrar el modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // Cerrar modal de selección de proveedores
        function closeSupplierSelectionModal() {
            const modal = document.getElementById('supplierSelectionModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }
        
        // Cargar la lista de proveedores en el modal
        function loadSupplierList() {
            const tbody = document.getElementById('supplierList');
            if (!tbody) return;
            
            tbody.innerHTML = ''; // Limpiar lista actual
            
            // Obtener proveedores del localStorage
            const proveedores = JSON.parse(localStorage.getItem('proveedores') || '[]');
            
            // Ordenar por nombre
            proveedores.sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            // Agregar cada proveedor a la tabla
            proveedores.forEach(proveedor => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${proveedor.nombre}</div>
                        <div class="text-sm text-gray-500">${proveedor.rfc || 'Sin RFC'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${proveedor.contacto || 'No especificado'}</div>
                        <div class="text-sm text-gray-500">${proveedor.email || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${proveedor.telefono || 'No especificado'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="selectSupplier('${proveedor.id}', '${proveedor.nombre}')" 
                            class="text-indigo-600 hover:text-indigo-900">
                            Seleccionar
                        </button>
                    </td>
                `;
                tr.dataset.supplierName = proveedor.nombre.toLowerCase();
                tbody.appendChild(tr);
            });
            
            // Limpiar búsqueda
            const searchInput = document.getElementById('supplierSearch');
            if (searchInput) searchInput.value = '';
        }
        
        // Seleccionar un proveedor
        function selectSupplier(id, nombre) {
            const select = document.getElementById('supplier');
            if (select) {
                // Buscar si ya existe una opción con este ID
                let optionExists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === id) {
                        select.selectedIndex = i;
                        optionExists = true;
                        break;
                    }
                }
                
                // Si no existe, agregarla
                if (!optionExists) {
                    const option = new Option(nombre, id);
                    select.add(option);
                    select.selectedIndex = select.options.length - 1;
                }
                
                // Cerrar el modal
                closeSupplierSelectionModal();
            }
        }
        
        // Filtrar proveedores por búsqueda
        function filterSuppliers() {
            const searchText = document.getElementById('supplierSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#supplierList tr');
            
            rows.forEach(row => {
                const supplierName = row.dataset.supplierName || '';
                if (supplierName.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Cerrar con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSupplierSelectionModal();
            }
        });
    </script>

    <!-- Modal de Factura -->
    <!-- Modal de Factura con Productos -->
    <div id="facturaSimpleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-lg font-semibold">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>
                    Nueva Factura de Compra
                </h3>
                <button onclick="cerrarFacturaSimple()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="facturaSimpleForm" class="overflow-y-auto flex-1 p-6 space-y-6">
                <!-- Información Básica -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor *</label>
                        <select id="proveedorFactura" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">Seleccionar proveedor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N° Factura *</label>
                        <input type="text" id="numeroFactura" readonly
                            class="mt-1 block w-full border border-gray-300 bg-gray-100 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Se generará automáticamente">
                    </div>
                    <div>
                        <label for="fechaFacturaInput" class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                        <div class="relative">
                            <input type="datetime-local" 
                                   id="fechaFacturaInput" 
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   value="">
                        </div>
                    </div>
                </div>

                <!-- Tabla de Productos -->
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                        <h4 class="text-sm font-medium text-gray-700">Productos</h4>
                        <div class="space-x-2">
                            <button type="button" 
                                class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                id="btnAgregarProducto"
                                onclick="abrirSelectorProductos()">
                                <i class="fas fa-plus mr-1"></i> Agregar Producto
                            </button>
                            <button type="button" onclick="verProductosSeleccionados()" 
                                class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-eye mr-1"></i> Ver seleccionados
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaProductos" class="bg-white divide-y divide-gray-200">
                                <!-- Filas de productos se agregarán aquí dinámicamente -->
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="4" class="px-4 py-3 text-right text-sm font-medium text-gray-700">Subtotal:</td>
                                    <td id="subtotalFactura" class="px-4 py-3 text-sm text-gray-900">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="px-4 py-1 text-right text-sm font-medium text-gray-700">
                                        <label class="flex items-center justify-end space-x-2">
                                            <input type="checkbox" id="aplicarIva" checked 
                                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                                onchange="calcularTotales()">
                                            <span>IVA (16%)</span>
                                        </label>
                                    </td>
                                    <td id="ivaFactura" class="px-4 py-1 text-sm text-gray-900">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="border-t border-gray-200">
                                    <td colspan="4" class="px-4 py-3 text-right text-base font-bold text-gray-900">Total:</td>
                                    <td id="totalFactura" class="px-4 py-3 text-base font-bold text-gray-900">$0.00</td>
                                    <input type="hidden" id="montoFactura" name="montoFactura" value="0">
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Notas -->
                <div>
                    <label for="descripcionFactura" class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                    <textarea id="descripcionFactura" rows="2"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Notas adicionales sobre la factura"></textarea>
                </div>

                <!-- Botones -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="cerrarFacturaSimple()" 
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                    <button type="button" 
                            id="agregarSeleccionados" 
                            onclick="seleccionarProductos()"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50" 
                            disabled>
                        <i class="fas fa-plus-circle mr-1"></i> Agregar Selección (<span id="contadorSeleccionados">0</span>)
                    </button>
                    <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-save mr-2"></i> Guardar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Selección de Productos -->
    <div id="productosModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <!-- Encabezado -->
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-blue-600 rounded-t-xl">
                <div class="flex items-center">
                    <div class="bg-white/10 p-2 rounded-lg mr-3">
                        <i class="fas fa-boxes text-white text-xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white">
                        Seleccionar Productos
                        <span id="contadorTotal" class="text-sm font-normal text-white/80 ml-2">(0 productos)</span>
                    </h3>
                </div>
                <button type="button" onclick="cerrarProductosModal()" class="text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Barra de búsqueda y filtros -->
            <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="buscarProducto" class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-lg leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-500 transition-all duration-200 shadow-sm" placeholder="Buscar productos por nombre o código...">
                    </div>
                    <div class="w-full sm:w-48">
                        <select id="filtroCategoria" class="block w-full pl-3 pr-10 py-2.5 text-base border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-500 transition-all duration-200 shadow-sm">
                            <option value="">Todas las categorías</option>
                            <!-- Categorías se cargarán dinámicamente -->
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Lista de productos -->
            <div class="flex-1 overflow-y-auto">
                <div class="min-w-full overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                    <input type="checkbox" id="seleccionarTodos" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </th>
                                <th scope="col" class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Código</th>
                                <th scope="col" class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                <th scope="col" class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Categoría</th>
                                <th scope="col" class="px-6 py-3.5 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Disponible</th>
                                <th scope="col" class="px-6 py-3.5 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Precio</th>
                            </tr>
                        </thead>
                        <tbody id="listaProductos" class="bg-white divide-y divide-gray-100">
                            <!-- Los productos se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Estado vacío -->
                <div id="estadoVacio" class="hidden py-12 text-center">
                    <div class="mx-auto w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-box-open text-indigo-400 text-2xl"></i>
                    </div>
                    <h4 class="text-gray-700 font-medium mb-1">No se encontraron productos</h4>
                    <p class="text-gray-500 text-sm max-w-md mx-auto">No hay productos que coincidan con tu búsqueda o filtros aplicados.</p>
                </div>
                
                <!-- Cargando -->
                <div id="estadoCargando" class="py-16 text-center">
                    <div class="animate-pulse flex flex-col items-center">
                        <div class="h-16 w-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-circle-notch fa-spin text-indigo-400 text-2xl"></i>
                        </div>
                        <div class="h-4 bg-gray-200 rounded w-1/3 mb-2"></div>
                        <div class="h-3 bg-gray-100 rounded w-2/3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Pie de página -->
            <div class="p-4 border-t border-gray-100 bg-white/80 backdrop-blur-sm flex flex-col sm:flex-row justify-between items-center gap-3">
                <div class="text-sm text-gray-600">
                    <span id="contadorSeleccionados" class="font-medium text-gray-800">0</span> productos seleccionados
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <button type="button" onclick="cerrarProductosModal()" class="w-full sm:w-auto px-5 py-2.5 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-100 transition-all duration-200 shadow-sm">
                        Cancelar
                    </button>
                    <button type="button" onclick="seleccionarProductos()" id="btnAgregarProductos" class="w-full sm:w-auto px-5 py-2.5 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2" disabled>
                        <i class="fas fa-plus-circle"></i>
                        <span>Agregar selección</span>
                        <span id="contadorBoton" class="bg-white/20 px-2 py-0.5 rounded-full text-xs">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts al final del body para asegurar que el DOM esté cargado -->
    <script>
        // Variables globales
        
        // Mostrar el modal de nueva factura
        function mostrarNuevaFactura() {
            console.log('Mostrando modal de factura...');
            const modal = document.getElementById('facturaSimpleModal');
            if (modal) {
                // Resetear el formulario
                const form = document.getElementById('facturaSimpleForm');
                if (form) form.reset();
                
                // Limpiar la tabla de productos
                const tbody = document.querySelector('#facturaSimpleForm table tbody');
                if (tbody) tbody.innerHTML = '';
                
                // Actualizar la fecha actual
                const now = new Date();
                const fechaInput = document.getElementById('fechaFacturaInput');
                if (fechaInput) {
                    fechaInput.value = now.toISOString().slice(0, 16);
                }
                
                // Mostrar el modal
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Cargar proveedores
                cargarProveedoresFactura();
                
                // Cargar productos
                cargarProductosInventario();
                
                console.log('Modal mostrado correctamente');
            } else {
                console.error('No se encontró el modal de factura');
            }
        }
        let contadorProductos = 0;
        let productosSeleccionados = [];
        let todosLosProductos = []; // Almacenará todos los productos cargados

        // Función para formatear moneda
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2
            }).format(valor);
        }

        // Función para calcular totales
        function calcularTotales() {
            console.log('=== INICIANDO CÁLCULO DE TOTALES ===');
            let subtotal = 0;
            const filas = document.querySelectorAll('#tablaProductos tr');
            const aplicarIva = document.getElementById('aplicarIva').checked;
            
            console.log(`Encontradas ${filas.length} filas en la tabla de productos`);
            console.log(`IVA ${aplicarIva ? 'activado' : 'desactivado'}`);
            
            // Calcular subtotal sumando todos los productos
            filas.forEach((fila, index) => {
                const priceInput = fila.querySelector('input[data-type="price"]');
                const quantityInput = fila.querySelector('input[data-type="quantity"]');
                
                if (priceInput && quantityInput) {
                    const price = parseFloat(priceInput.value) || 0;
                    const quantity = parseInt(quantityInput.value) || 0;
                    const rowSubtotal = price * quantity;
                    
                    // Actualizar el subtotal en la fila
                    const subtotalCell = fila.querySelector('.subtotal');
                    if (subtotalCell) {
                        subtotalCell.textContent = formatearMoneda(rowSubtotal);
                    }
                    
                    // Actualizar el atributo de datos para el subtotal
                    fila.dataset.subtotal = rowSubtotal.toFixed(2);
                    
                    subtotal += rowSubtotal;
                    
                    console.log(`Producto ${index + 1}: ${quantity} x $${price.toFixed(2)} = $${rowSubtotal.toFixed(2)}`);
                }
            });
            
            // Calcular IVA (16%) solo si está activado
            const iva = aplicarIva ? subtotal * 0.16 : 0;
            const total = aplicarIva ? subtotal * 1.16 : subtotal;
            
            console.log('Resumen de totales:', { 
                subtotal: `$${subtotal.toFixed(2)}`,
                ivaAplicado: aplicarIva ? '16%' : '0%',
                iva: `$${iva.toFixed(2)}`, 
                total: `$${total.toFixed(2)}` 
            });
            
            // Actualizar la interfaz de usuario
            const subtotalElement = document.getElementById('subtotalFactura');
            const ivaElement = document.getElementById('ivaFactura');
            const ivaRow = ivaElement ? ivaElement.closest('tr') : null;
            const totalElement = document.getElementById('totalFactura');
            const montoInput = document.getElementById('montoFactura');
            
            if (subtotalElement) subtotalElement.textContent = formatearMoneda(subtotal);
            
            // Actualizar fila de IVA
            if (ivaElement) {
                ivaElement.textContent = formatearMoneda(iva);
                if (ivaRow) {
                    if (aplicarIva) {
                        ivaRow.classList.remove('opacity-50');
                    } else {
                        ivaRow.classList.add('opacity-50');
                    }
                }
            }
            
            if (totalElement) totalElement.textContent = formatearMoneda(total);
            if (montoInput) montoInput.value = total.toFixed(2);
            
            console.log('=== FIN DEL CÁLCULO DE TOTALES ===');
            return total;
        }

        // Función para eliminar una fila de producto
        function eliminarFilaProducto(button) {
            const fila = button.closest('tr');
            fila.remove();
            calcularTotales();
        }

        // Función para agregar una nueva fila de producto
        function agregarFilaProducto(producto = null) {
            contadorProductos++;
            const tbody = document.getElementById('tablaProductos');
            const nuevaFila = document.createElement('tr');
            nuevaFila.className = 'producto-fila';
            
            // Si se proporciona un producto, usamos sus datos
            const codigo = producto ? producto.codigo : '';
            const nombre = producto ? producto.nombre : '';
            const precio = producto ? producto.precio.toFixed(2) : '0.00';
            const cantidad = producto ? '1' : '1';
            
            nuevaFila.innerHTML = `
                <td class="px-4 py-2 whitespace-nowrap">
                    <input type="text" class="codigo w-full border rounded px-2 py-1 text-sm" 
                           value="${codigo}" placeholder="Código" required>
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <input type="text" class="producto w-full border rounded px-2 py-1 text-sm" 
                           value="${nombre}" placeholder="Nombre del producto" required>
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <input type="number" min="1" step="1" value="${cantidad}" 
                           class="cantidad w-20 border rounded px-2 py-1 text-sm" required
                           onchange="calcularTotales()">
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" min="0.01" step="0.01" value="${precio}" 
                               class="precio pl-7 w-24 border rounded px-2 py-1 text-sm" required
                               onchange="calcularTotales()">
                    </div>
                </td>
                <td class="px-4 py-2 whitespace-nowrap subtotal text-sm">${formatearMoneda(parseFloat(precio) * parseInt(cantidad))}</td>
                <td class="px-4 py-2 whitespace-nowrap text-right">
                    <button type="button" onclick="eliminarFilaProducto(this)" 
                            class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(nuevaFila);
            
            // Si es un producto nuevo (no seleccionado), enfocar el campo de código
            if (!producto) {
                nuevaFila.querySelector('.codigo').focus();
            } else {
                // Si es un producto seleccionado, actualizar totales
                calcularTotales();
            }
        }

        // Función para depurar el inventario
        function depurarInventario() {
            console.clear();
            console.log('=== DEPURACIÓN DE INVENTARIO ===');
            
            // Verificar todas las claves de localStorage
            console.log('=== CLAVES EN LOCALSTORAGE ===');
            Object.keys(localStorage).forEach(key => {
                console.log(`- ${key}`);
            });
            
            // Buscar claves relacionadas con el inventario
            const clavesInventario = Object.keys(localStorage).filter(key => 
                key.toLowerCase().includes('invent') || 
                key.toLowerCase().includes('product')
            );
            
            console.log('\n=== CLAVES DE INVENTARIO ENCONTRADAS ===', clavesInventario);
            
            // Mostrar el contenido de cada clave de inventario
            clavesInventario.forEach(clave => {
                try {
                    const datos = localStorage.getItem(clave);
                    console.log(`\n=== CONTENIDO DE ${clave} ===`);
                    if (datos) {
                        const parsed = JSON.parse(datos);
                        console.log(parsed);
                        
                        // Si es un array de productos, mostrar el primero
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log(`\nPrimer producto en ${clave}:`, parsed[0]);
                        }
                    }
                } catch (e) {
                    console.error(`Error al leer ${clave}:`, e);
                }
            });
            
            // Mostrar el contenido de la clave específica que estamos usando
            const clavePrincipal = 'inventoryProducts';
            console.log(`\n=== INTENTANDO CARGAR DESDE ${clavePrincipal} ===`);
            const productos = localStorage.getItem(clavePrincipal);
            
            if (productos) {
                try {
                    const productosParseados = JSON.parse(productos);
                    console.log('Productos encontrados:', productosParseados);
                    
                    if (Array.isArray(productosParseados)) {
                        console.log(`\n=== RESUMEN DE PRODUCTOS (${productosParseados.length}) ===`);
                        productosParseados.forEach((p, i) => {
                            console.log(`#${i + 1}: ${p.name || p.nombre || 'Sin nombre'} | ` +
                                      `Precio: ${p.price || p.precio || 'N/A'} | ` +
                                      `Stock: ${p.stock || p.existencia || 0}`);
                        });
                    }
                    
                    return productosParseados;
                } catch (e) {
                    console.error('Error al parsear productos:', e);
                }
            } else {
                console.warn(`No se encontró la clave '${clavePrincipal}' en localStorage`);
            }
            
            return [];
        }
        
        // Función para cargar productos del inventario
        function cargarProductosInventario() {
            console.log('=== INICIANDO CARGA DE PRODUCTOS ===');
            
            let productosInventario = [];
            
            // 1. Intentar cargar desde la base de datos
            try {
                if (window.db && typeof window.db.getProductos === 'function') {
                    console.log('Intentando cargar productos desde la base de datos...');
                    const productosDB = window.db.getProductos();
                    
                    if (Array.isArray(productosDB) && productosDB.length > 0) {
                        console.log(`Se encontraron ${productosDB.length} productos en la base de datos`);
                        productosInventario = productosDB;
                        // Guardar en localStorage como caché
                        try {
                            localStorage.setItem('productosInventario', JSON.stringify(productosDB));
                            console.log('Productos guardados en caché (localStorage)');
                        } catch (e) {
                            console.warn('No se pudo guardar en localStorage:', e.message);
                        }
                    } else {
                        console.warn('La base de datos no devolvió productos o está vacía');
                    }
                } else {
                    console.warn('La base de datos no está disponible o no tiene el método getProductos');
                }
            } catch (dbError) {
                console.error('Error al acceder a la base de datos:', dbError);
            }
            
            // 2. Si no hay productos de la base de datos, intentar cargar de localStorage
            if (productosInventario.length === 0) {
                console.log('Intentando cargar productos desde localStorage...');
                try {
                    const productosGuardados = localStorage.getItem('productosInventario');
                    if (productosGuardados) {
                        const parsed = JSON.parse(productosGuardados);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log(`Se cargaron ${parsed.length} productos desde localStorage`);
                            productosInventario = parsed;
                        }
                    }
                } catch (localError) {
                    console.error('Error al cargar productos desde localStorage:', localError);
                }
            }
            
            // 3. Si aún no hay productos, usar datos de ejemplo
            if (productosInventario.length === 0) {
                console.warn('No se encontraron productos, cargando datos de ejemplo...');
                productosInventario = [
                    { 
                        id: 1, 
                        codigo: 'PROD001', 
                        nombre: 'Producto de Ejemplo 1', 
                        categoria: 'Electrónicos', 
                        precio: 1250.50, 
                        stock: 15, 
                        descripcion: 'Producto de ejemplo 1',
                        proveedor: 'Proveedor Ejemplo',
                        costo: 1000.00
                    },
                    { 
                        id: 2, 
                        codigo: 'PROD002', 
                        nombre: 'Producto de Ejemplo 2', 
                        categoria: 'Oficina', 
                        precio: 450.75, 
                        stock: 8, 
                        descripcion: 'Producto de ejemplo 2',
                        proveedor: 'Proveedor Ejemplo',
                        costo: 350.00
                    },
                    { 
                        id: 3, 
                        codigo: 'PROD003', 
                        nombre: 'Producto de Ejemplo 3', 
                        categoria: 'Limpieza', 
                        precio: 89.90, 
                        stock: 25, 
                        descripcion: 'Producto de ejemplo 3',
                        proveedor: 'Proveedor Ejemplo',
                        costo: 60.00
                    }
                ];
                
                // Guardar los productos de ejemplo en localStorage
                try {
                    localStorage.setItem('productosInventario', JSON.stringify(productosInventario));
                    console.log('Datos de ejemplo guardados en localStorage');
                } catch (e) {
                    console.warn('No se pudieron guardar los datos de ejemplo en localStorage:', e.message);
                }
            }
            
            // Procesar los productos para asegurar que tengan el formato correcto
            const productosProcesados = productosInventario.map((producto, index) => {
                // Generar un ID único si no existe
                const id = producto.id || `temp-${Date.now()}-${index}`;
                
                // Crear el objeto de producto con valores por defecto
                return {
                    id: id,
                    codigo: producto.codigo || `PROD${String(id).padStart(3, '0')}`,
                    nombre: producto.nombre || `Producto ${index + 1}`,
                    categoria: producto.categoria || 'Sin categoría',
                    precio: Math.max(0, parseFloat(producto.precio) || 0),
                    existencia: Math.max(0, parseInt(producto.stock || producto.existencia || '0')),
                    descripcion: producto.descripcion || '',
                    proveedor: producto.proveedor || 'Sin proveedor',
                    costo: Math.max(0, parseFloat(producto.costo) || 0)
                };
            });
            
            console.log(`=== CARGA COMPLETADA: ${productosProcesados.length} productos cargados ===`);
            if (productosProcesados.length > 0) {
                console.log('Ejemplo de producto cargado:', JSON.parse(JSON.stringify(productosProcesados[0])));
            }
            
            return productosProcesados;
        }
        
        // Función para agregar un producto a la tabla de la factura
        function agregarProductoATabla(producto) {
            console.log('Agregando producto a la tabla:', producto);
            
            // Encontrar el tbody donde se agregarán los productos
            const tbody = document.querySelector('#tablaProductos');
            if (!tbody) {
                console.error('No se encontró el cuerpo de la tabla de productos');
                console.log('Buscando tabla con id tablaProductos:', document.getElementById('tablaProductos'));
                return false;
            }

            // Verificar si el producto ya está en la tabla
            const productoId = producto.id || producto.codigo;
            const filaExistente = tbody.querySelector(`tr[data-producto-id="${productoId}"]`);
            
            if (filaExistente) {
                console.log('El producto ya está en la tabla, aumentando cantidad');
                const cantidadInput = filaExistente.querySelector('input[data-type="quantity"]');
                if (cantidadInput) {
                    const cantidadActual = parseInt(cantidadInput.value) || 0;
                    const maxCantidad = parseInt(filaExistente.dataset.maxCantidad) || 9999;
                    const nuevaCantidad = Math.min(cantidadActual + 1, maxCantidad);
                    cantidadInput.value = nuevaCantidad;
                    updateRowTotal(cantidadInput);
                }
                return true;
            }

            // Validar y formatear datos del producto
            const existencia = parseInt(producto.existencia || 0);
            const precio = parseFloat(producto.precio) || 0;
            const codigo = producto.codigo || '';
            const nombre = producto.nombre || 'Producto sin nombre';
            const categoria = producto.categoria || '';
            
            console.log('Datos del producto a agregar:', {
                id: productoId,
                codigo,
                nombre,
                categoria,
                precio,
                existencia
            });

            // Crear nueva fila para el producto
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.dataset.productoId = productoId;
            row.dataset.precioUnitario = precio;
            row.dataset.maxCantidad = existencia;

            row.innerHTML = `
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${codigo}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${nombre}</td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <input type="number" 
                           data-type="quantity" 
                           class="w-20 px-2 py-1 border rounded text-sm" 
                           value="1" 
                           min="1" 
                           max="${existencia || ''}"
                           onchange="updateRowTotal(this)"
                           title="Cantidad">
                </td>
                <td class="px-4 py-2 whitespace-nowrap">
                    <div class="relative">
                        <span class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">$</span>
                        <input type="number" 
                               data-type="price" 
                               step="0.01" 
                               class="w-24 pl-6 py-1 border rounded text-sm" 
                               value="${precio.toFixed(2)}" 
                               min="0" 
                               onchange="updateRowTotal(this)"
                               title="Precio unitario">
                    </div>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right subtotal">
                    ${formatearMoneda(precio)}
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                    <button type="button" 
                            class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50"
                            onclick="eliminarFilaProducto(this)" 
                            title="Eliminar producto">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            // Insertar la nueva fila
            tbody.appendChild(row);
            
            // Actualizar totales
            updateRowTotal(row.querySelector('input[data-type="quantity"]'));
            calcularTotales();
            
            console.log('Producto agregado correctamente a la tabla');
            return true;
        }
        
        // Función para mostrar el modal de selección de productos con animación
        window.mostrarSeleccionProductos = async function() {
            console.log('Mostrando selección de productos...');
            
            // Obtener referencias a los elementos del DOM
            const modal = document.getElementById('productosModal');
            const modalContent = document.getElementById('modalContent');
            
            if (!modal || !modalContent) {
                console.error('No se encontró el modal de productos o su contenido');
                console.log('Elementos buscados:', {modal, modalContent});
                alert('No se pudo abrir el selector de productos. Por favor, recargue la página e intente nuevamente.');
                return;
            }
            
            // Mostrar el modal
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Forzar reflow para activar la transición
            void modal.offsetWidth;
            
            // Aplicar animación de entrada
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
            const estadoCargando = document.getElementById('estadoCargando');
            const estadoVacio = document.getElementById('estadoVacio');
            const listaProductos = document.getElementById('listaProductos');
            
            // Verificar que todos los elementos necesarios existan
            if (!modal || !modalContent || !estadoCargando || !estadoVacio || !listaProductos) {
                console.error('No se encontraron elementos necesarios del modal');
                return;
            }
            
            // Mostrar el modal con animación
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Forzar reflow para activar la transición
            void modal.offsetWidth;
            
            // Aplicar animación de entrada
            modal.classList.add('opacity-100');
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
            
            // Mostrar estado de carga
            estadoCargando.classList.remove('hidden');
            estadoVacio.classList.add('hidden');
            listaProductos.innerHTML = '';
            
            try {
                // Cargar productos del inventario
                let productos = await cargarProductosInventario();
                console.log('Productos cargados:', productos);
                
                // Ocultar estado de carga
                estadoCargando.classList.add('hidden');
                
                // Si no hay productos, mostrar estado vacío
                if (!productos || !Array.isArray(productos) || productos.length === 0) {
                    estadoVacio.classList.remove('hidden');
                    return;
                }

                // Construir el HTML de la tabla de productos
                const productosHTML = productos.map(producto => {
                    const productoEnFactura = document.querySelector(`#tablaProductos tr[data-producto-id="${producto.id}"]`);
                    const cantidadEnFactura = productoEnFactura ? 
                        parseInt(productoEnFactura.querySelector('input[data-type="quantity"]')?.value || '0') : 0;
                    const existencia = producto.existencia !== undefined ? 
                        (typeof producto.existencia === 'number' ? producto.existencia : parseInt(producto.existencia) || 0) : 
                        (producto.stock !== undefined ? 
                            (typeof producto.stock === 'number' ? producto.stock : parseInt(producto.stock) || 0) : 
                            0);
                    const disponible = Math.max(0, existencia - cantidadEnFactura);
                    const precio = parseFloat(producto.precio) || 0;
                    
                    return `
                        <tr class="producto-item hover:bg-gray-50" 
                            data-nombre="${(producto.nombre || '').toLowerCase()}" 
                            data-codigo="${(producto.codigo || '').toLowerCase()}" 
                            data-categoria="${(producto.categoria || '').toLowerCase()}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" 
                                    class="producto-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                                    value="${producto.id}" 
                                    data-precio="${precio}"
                                    data-existencia="${disponible}"
                                    onchange="actualizarContadorSeleccionados()"
                                    ${disponible <= 0 ? 'disabled' : ''}>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${producto.codigo || 'N/A'}
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">${producto.nombre || 'Sin nombre'}</div>
                                ${producto.descripcion ? `<div class="text-xs text-gray-500 truncate max-w-xs">${producto.descripcion}</div>` : ''}
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${producto.categoria || 'Sin categoría'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-sm ${disponible > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${disponible} ${producto.unidad || (producto.unidad_medida || 'un')}
                                </div>
                                ${cantidadEnFactura > 0 ? 
                                    `<div class="text-xs text-gray-400">
                                        (${cantidadEnFactura} en factura)
                                    </div>` : ''}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-sm font-medium text-gray-900">${formatearMoneda(precio)}</div>
                            </td>
                        </tr>`;
                }).join('');
                
                // Actualizar el contenido del modal
                listaProductos.innerHTML = productosHTML;
                
                // Actualizar contador de productos
                const contadorProductos = document.getElementById('contadorProductos');
                if (contadorProductos) {
                    contadorProductos.textContent = productos.length;
                }
                
                // Inicializar el buscador
                const buscarProducto = document.getElementById('buscarProducto');
                if (buscarProducto) {
                    buscarProducto.addEventListener('input', function(e) {
                        const busqueda = e.target.value.toLowerCase();
                        const items = document.querySelectorAll('.producto-item');
                        const contadorProductos = document.getElementById('contadorProductos');
                        
                        let productosVisibles = 0;
                        items.forEach(item => {
                            const nombre = item.getAttribute('data-nombre') || '';
                            const codigo = item.getAttribute('data-codigo') || '';
                            const categoria = item.getAttribute('data-categoria') || '';
                            
                            if (nombre.includes(busqueda) || codigo.includes(busqueda) || categoria.includes(busqueda)) {
                                item.classList.remove('hidden');
                                productosVisibles++;
                            } else {
                                item.classList.add('hidden');
                            }
                        });
                        
                        // Actualizar contador
                        if (contadorProductos) {
                            contadorProductos.textContent = productosVisibles;
                        }
                    });
                }
                
                // Enfocar el campo de búsqueda
                if (buscarProducto) {
                    buscarProducto.focus();
                }
            } catch (error) {
                console.error('Error al cargar los productos:', error);
                
                // Mostrar mensaje de error en la interfaz
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-4 text-red-600 bg-red-50 rounded-md';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Error al cargar los productos. Por favor, intente nuevamente.</span>
                    </div>`;
                
                // Limpiar el modal y mostrar el error
                const modalContent = document.getElementById('modalContent');
                if (modalContent) {
                    modalContent.innerHTML = '';
                    modalContent.appendChild(errorDiv);
                    
                    // Agregar botón de reintentar
                    const retryButton = document.createElement('button');
                    retryButton.type = 'button';
                    retryButton.className = 'mt-4 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
                    retryButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Reintentar';
                    retryButton.onclick = mostrarSeleccionProductos;
                    
                    modalContent.appendChild(retryButton);
                } else if (estadoVacio) {
                    estadoVacio.textContent = 'Error al cargar los productos. Por favor, intente nuevamente.';
                    estadoVacio.classList.remove('hidden');
                }
            });
        }
        
        // Función para actualizar el contador de productos seleccionados
        function actualizarContadorSeleccionados() {
            try {
                const checkboxes = document.querySelectorAll('#listaProductos input[type="checkbox"]:checked');
                const contador = checkboxes.length;
                const btnAgregar = document.getElementById('btnAgregarProductos');
                const contadorElement = document.getElementById('contadorSeleccionados');
                const contadorBoton = document.getElementById('contadorBoton');
                const botonSeleccionar = document.getElementById('agregarSeleccionados');
                const totalProductos = document.querySelectorAll('#listaProductos tr.producto-item').length;
                
                // Actualizar contadores
                if (contadorElement) contadorElement.textContent = contador;
                if (contadorBoton) contadorBoton.textContent = contador;
                
                // Habilitar/deshabilitar botón de agregar
                if (btnAgregar) {
                    btnAgregar.disabled = contador === 0;
                }
                
                // Actualizar estado del botón de selección
                if (botonSeleccionar) {
                    botonSeleccionar.disabled = contador === 0;
                    botonSeleccionar.className = contador > 0 
                        ? 'bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center'
                        : 'bg-gray-300 text-gray-500 px-4 py-2 rounded-md cursor-not-allowed flex items-center';
                }
                
                // Actualizar estado del checkbox "Seleccionar todos"
                const seleccionarTodos = document.getElementById('seleccionarTodos');
                if (seleccionarTodos) {
                    seleccionarTodos.checked = contador > 0 && contador === totalProductos;
                    seleccionarTodos.indeterminate = contador > 0 && contador < totalProductos;
                }
            } catch (error) {
                console.error('Error en actualizarContadorSeleccionados:', error);
            }
        }
        
        // Función para cerrar el modal de selección de productos con animación
        function cerrarProductosModal() {
            const modal = document.getElementById('productosModal');
            const modalContent = document.getElementById('modalContent');
            
            if (!modal || !modalContent) return;
            
            // Aplicar animación de salida
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            
            // Ocultar el modal después de la animación
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 200);
        }
        
        // Función para manejar la selección de todos los productos
        function manejarSeleccionTodos() {
            try {
                const seleccionarTodos = document.getElementById('seleccionarTodos');
                const checkboxes = document.querySelectorAll('#listaProductos input[type="checkbox"]');
                
                if (!seleccionarTodos) return;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = seleccionarTodos.checked;
                });
                
                actualizarContadorSeleccionados();
            } catch (error) {
                console.error('Error en manejarSeleccionTodos:', error);
            }
        }
        
        // Función para inicializar los eventos del modal de productos
        function inicializarEventosModalProductos() {
            try {
                // Evento para el checkbox "Seleccionar todos"
                const seleccionarTodos = document.getElementById('seleccionarTodos');
                if (seleccionarTodos) {
                    seleccionarTodos.addEventListener('change', manejarSeleccionTodos);
                }
                
                // Evento para la búsqueda de productos
                const buscarProducto = document.getElementById('buscarProducto');
                if (buscarProducto) {
                    buscarProducto.addEventListener('input', function(e) {
                        const busqueda = e.target.value.toLowerCase();
                        const filas = document.querySelectorAll('#listaProductos tr.producto-item');
                        let productosVisibles = 0;
                        
                        filas.forEach(fila => {
                            const textoFila = fila.textContent.toLowerCase();
                            if (textoFila.includes(busqueda)) {
                                fila.classList.remove('hidden');
                                productosVisibles++;
                            } else {
                                fila.classList.add('hidden');
                            }
                        });
                        
                        // Actualizar contador de productos visibles
                        const contador = document.getElementById('contadorProductos');
                        if (contador) contador.textContent = productosVisibles;
                        
                        // Mostrar/ocultar estado vacío
                        const estadoVacio = document.getElementById('estadoVacio');
                        if (estadoVacio) {
                            if (productosVisibles === 0) {
                                estadoVacio.classList.remove('hidden');
                            } else {
                                estadoVacio.classList.add('hidden');
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error en inicializarEventosModalProductos:', error);
            }
            }
        }
        
        // Asegurar que la función esté disponible globalmente
        if (typeof window.mostrarSeleccionProductos === 'undefined') {
            window.mostrarSeleccionProductos = mostrarSeleccionProductos;
        }

        // Inicializar eventos cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando módulo de compras...');
            
            // Hacer que las funciones sean accesibles globalmente
            window.mostrarNuevaFactura = mostrarNuevaFactura;
            window.mostrarFacturaSimple = mostrarFacturaSimple;
            window.mostrarSeleccionProductos = mostrarSeleccionProductos;
            
            // Configurar el botón de agregar producto
            const configurarBotonAgregar = () => {
                const btnAgregarProducto = document.getElementById('btnAgregarProducto');
                if (btnAgregarProducto) {
                    // Clonar el botón para limpiar cualquier evento existente
                    const nuevoBoton = btnAgregarProducto.cloneNode(true);
                    btnAgregarProducto.parentNode.replaceChild(nuevoBoton, btnAgregarProducto);
                    
                    // Agregar el manejador de eventos al nuevo botón
                    nuevoBoton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Botón Agregar Producto clickeado');
                        
                        // Verificar si la función existe antes de llamarla
                        if (typeof window.mostrarSeleccionProductos === 'function') {
                            window.mostrarSeleccionProductos();
                        } else {
                            console.error('La función mostrarSeleccionProductos no está definida');
                            alert('Error: No se pudo abrir el selector de productos. Por favor, recargue la página.');
                        }
                    });
                    
                    console.log('Botón Agregar Producto configurado correctamente');
                    return true;
                } else {
                    console.warn('No se encontró el botón de Agregar Producto');
                    return false;
                }
            };
            
            // Intentar configurar el botón de agregar producto
            let intentos = 0;
            const maxIntentos = 5;
            const intervalo = setInterval(() => {
                if (configurarBotonAgregar() || intentos >= maxIntentos) {
                    clearInterval(intervalo);
                    if (intentos >= maxIntentos) {
                        console.error('No se pudo configurar el botón después de varios intentos');
                    }
                }
                intentos++;
            }, 300); // Intentar cada 300ms hasta que se configure o se alcance el máximo de intentos
            
            // Función para mostrar el modal de factura
            window.mostrarNuevaFactura = function() {
                console.log('Mostrando modal de factura...');
                const modal = document.getElementById('facturaSimpleModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    console.log('Modal de factura mostrado correctamente');
                    
                    // Cargar productos al abrir el modal de factura
                    cargarProductosInventario().then(productos => {
                        console.log('Productos cargados para la factura:', productos.length);
                    }).catch(error => {
                        console.error('Error al cargar productos:', error);
                    });
                } else {
                    console.error('No se encontró el modal de factura');
                }
            };
            
            // Configurar el botón de nueva factura
            const btnNuevaFactura = document.getElementById('btnNuevaFactura');
            if (btnNuevaFactura) {
                btnNuevaFactura.onclick = mostrarNuevaFactura;
                console.log('Botón de nueva factura configurado');
            } else {
                console.warn('No se encontró el botón de nueva factura');
            }
            
            // Inicializar eventos del modal de productos
            console.log('Inicializando eventos del modal de productos...');
            inicializarEventosModalProductos();
            
            // Verificar si el modal de factura existe
            const modal = document.getElementById('facturaSimpleModal');
            if (!modal) {
                console.error('No se encontró el modal de factura');
            }
            
            console.log('Módulo de compras inicializado correctamente');
        });
        
        // Función para agregar los productos seleccionados a la factura
        function seleccionarProductos() {
            console.log('=== INICIANDO SELECCIÓN DE PRODUCTOS ===');
            
            const productosSeleccionados = [];
            const checkboxes = document.querySelectorAll('#listaProductos input[type="checkbox"]:checked');
            
            // Verificar que se hayan seleccionado productos
            if (checkboxes.length === 0) {
                console.warn('No se seleccionaron productos');
                mostrarNotificacion('Por favor seleccione al menos un producto', 'warning');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const fila = checkbox.closest('tr');
                if (fila) {
                    const producto = {
                        id: fila.dataset.id,
                        codigo: fila.dataset.codigo,
                        nombre: fila.dataset.nombre,
                        precio: parseFloat(fila.dataset.precio),
                        existencia: parseInt(fila.dataset.existencia),
                        unidad: fila.dataset.unidad || 'un',
                        cantidad: 1 // Cantidad predeterminada
                    };
                    productosSeleccionados.push(producto);
                }
            });
            
            // Agregar productos a la factura
            if (productosSeleccionados.length > 0) {
                productosSeleccionados.forEach(producto => {
                    agregarProductoATabla(producto);
                });
                
                // Cerrar el modal después de agregar
                cerrarProductosModal();
                
                // Mostrar notificación de éxito
                mostrarNotificacion(`Se agregaron ${productosSeleccionados.length} productos a la factura`, 'success');
            }
            
            // Verificar si la tabla de productos existe
            const tablaProductos = document.getElementById('tablaProductos');
            if (!tablaProductos) {
                console.error('ERROR: No se encontró la tabla de productos (elemento con id "tablaProductos")');
                console.log('Elementos con id "tablaProductos":', document.querySelectorAll('#tablaProductos'));
                alert('Error: No se pudo encontrar la tabla de productos');
                return null;
            }
            console.log('Tabla de productos encontrada:', tablaProductos);
            
            // Contador de productos agregados
            let productosAgregados = 0;
            
            // Procesar cada producto seleccionado
            checkboxes.forEach((checkbox, index) => {
                console.log(`Procesando producto ${index + 1}/${checkboxes.length}`);
                const fila = checkbox.closest('tr');
                if (!fila) {
                    console.warn('No se pudo encontrar la fila del producto');
                    return;
                }
                
                // Extraer datos del producto
                const producto = {
                    id: checkbox.value,
                    codigo: fila.cells[1].textContent.trim(),
                    nombre: fila.cells[2].textContent.trim(),
                    categoria: fila.cells[3].textContent.trim(),
                    precio: parseFloat(checkbox.dataset.precio) || 0,
                    existencia: parseInt(checkbox.dataset.existencia) || 0
                };
                
                console.log('Datos del producto a agregar:', producto);
                
                try {
                    // Verificar si el producto ya está en la tabla
                    const selector = `tr[data-producto-id="${producto.id}"]`;
                    console.log('Buscando producto existente con selector:', selector);
                    const productoExistente = tablaProductos.querySelector(selector);
                    console.log('Producto existente encontrado:', productoExistente);
                    
                    if (productoExistente) {
                        console.log('Producto ya existe en la tabla, incrementando cantidad');
                        const cantidadInput = productoExistente.querySelector('input[data-type="quantity"]');
                        if (cantidadInput) {
                            const cantidadActual = parseInt(cantidadInput.value) || 0;
                            cantidadInput.value = cantidadActual + 1;
                            updateRowTotal(cantidadInput);
                            productosAgregados++;
                        } else {
                            console.warn('No se encontró el input de cantidad para el producto existente');
                        }
                    } else {
                        console.log('Agregando nuevo producto a la tabla');
                        const resultado = agregarProductoATabla(producto);
                        if (resultado) {
                            console.log('Producto agregado exitosamente');
                            productosAgregados++;
                        } else {
                            console.warn('No se pudo agregar el producto');
                        }
                    }
                } catch (error) {
                    console.error('Error al procesar el producto:', error);
                }
            });
            
            console.log(`Productos procesados: ${productosAgregados} de ${checkboxes.length}`);
            
            // Cerrar el modal
            cerrarProductosModal();
            
            // Actualizar totales solo si se agregaron productos
            if (productosAgregados > 0) {
                console.log(`Se agregaron ${productosAgregados} productos correctamente`);
                calcularTotales();
                updateOrderTotal();
                
                // Mostrar notificación de éxito
                const notificacion = document.createElement('div');
                notificacion.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg';
                notificacion.textContent = `Se agregaron ${productosAgregados} productos a la factura`;
                document.body.appendChild(notificacion);
                
                // Eliminar notificación después de 3 segundos
                setTimeout(() => {
                    notificacion.remove();
                }, 3000);
            } else {
                console.warn('No se agregó ningún producto a la factura');
                alert('No se pudo agregar ningún producto a la factura. Por favor verifica la consola para más detalles.');
            }
        }
        
        // Función para cargar los proveedores en el select
        function cargarProveedoresFactura() {
            const select = document.getElementById('proveedorFactura');
            
            // Verificar si el select existe
            if (!select) {
                console.error('No se encontró el elemento con ID proveedorFactura');
                return false;
            }
            
            // Obtener proveedores del localStorage
            let proveedores = [];
            try {
                const proveedoresGuardados = localStorage.getItem('proveedores');
                
                if (proveedoresGuardados) {
                    proveedores = JSON.parse(proveedoresGuardados);
                    
                    if (!Array.isArray(proveedores)) {
                        console.error('Error: Los proveedores no son un array válido');
                        proveedores = [];
                    }
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
                proveedores = [];
            }
            
            // Guardar la opción por defecto
            const defaultOption = select.options[0] ? select.options[0].outerHTML : '';
            
            // Limpiar todas las opciones
            select.innerHTML = defaultOption || '<option value="">Seleccionar proveedor</option>';
            
            // Verificar si hay proveedores
            if (proveedores.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay proveedores disponibles';
                select.appendChild(option);
                return false;
            }
            
            // Ordenar proveedores por nombre
            proveedores.sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            // Agregar cada proveedor al select
            proveedores.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor.id || proveedor.nombre;
                option.textContent = proveedor.nombre;
                
                // Agregar datos adicionales como atributos personalizados
                if (proveedor.telefono) option.dataset.telefono = proveedor.telefono;
                if (proveedor.email) option.dataset.email = proveedor.email;
                if (proveedor.direccion) option.dataset.direccion = proveedor.direccion;
                
                select.appendChild(option);
            });
            
            // Si solo hay un proveedor, seleccionarlo por defecto
            if (proveedores.length === 1) {
                select.selectedIndex = 1; // Índice 1 porque el 0 es el placeholder
            }
            
            console.log('Proveedores cargados correctamente:', proveedores.length);
            return proveedores.length > 0; // Retorna true si se cargaron proveedores
        }
        
        // Función para verificar el contenido del localStorage
        function verificarLocalStorage() {
            console.log('=== VERIFICACIÓN DE LOCALSTORAGE ===');
            console.log('Claves en localStorage:', Object.keys(localStorage));
            
            const proveedores = localStorage.getItem('proveedores');
            console.log('Contenido de "proveedores":', proveedores);
            
            if (proveedores) {
                try {
                    const parsed = JSON.parse(proveedores);
                    console.log('Proveedores parseados:', parsed);
                    console.log('Número de proveedores:', parsed.length);
                } catch (e) {
                    console.error('Error al analizar proveedores:', e);
                }
            } else {
                console.warn('No se encontró la clave "proveedores" en localStorage');
            }
            
            // Verificar si el select existe
            const select = document.getElementById('proveedorFactura');
            console.log('Elemento select encontrado:', select ? 'Sí' : 'No');
            if (select) {
                console.log('Número de opciones en el select:', select.options.length);
                console.log('Opciones:', Array.from(select.options).map(opt => ({
                    value: opt.value,
                    text: opt.text,
                    selected: opt.selected
                })));
            }
        }
        
        // Función para mostrar el modal de factura - Asegurarse de que sea global
        window.mostrarFacturaSimple = function() {
            console.log('Función mostrarFacturaSimple llamada');
            const modal = document.getElementById('facturaSimpleModal');
            if (!modal) {
                console.error('No se encontró el modal de factura');
                return;
            }
            
            // Mostrar el modal
            console.log('Mostrando modal de factura...');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Forzar reflow para activar la transición
            void modal.offsetWidth;
            
            // Asegurarse de que el modal sea visible
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modal.querySelector('div').classList.remove('opacity-0', 'scale-95');
                modal.querySelector('div').classList.add('opacity-100', 'scale-100');
            }, 10);
            
            // Limpiar el formulario
            const form = document.getElementById('facturaSimpleForm');
            if (form) form.reset();
            
            // Cargar proveedores en el select
            cargarProveedoresFactura();
            
            // Limpiar tabla de productos
            const tablaProductos = document.getElementById('tablaProductos');
            if (tablaProductos) tablaProductos.innerHTML = '';
            
            // Reiniciar array de productos seleccionados
            window.productosSeleccionados = [];
            
            // Establecer fecha y hora actual como valor predeterminado
            const now = new Date();
            // Ajustar al formato YYYY-MM-DDThh:mm
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            const fechaInput = document.getElementById('fechaFacturaInput');
            if (fechaInput) {
                // Establecer la fecha y hora actual como valor predeterminado
                fechaInput.value = currentDateTime;
                // Permitir seleccionar cualquier fecha entre 2000 y 2100
                fechaInput.min = '2000-01-01';
                fechaInput.max = '2100-12-31';
                // Asegurar que el campo sea completamente editable
                fechaInput.readOnly = false;
                // Forzar la actualización del valor mostrado
                fechaInput.defaultValue = currentDateTime;
            }
            
            // Generar y establecer número de factura secuencial
            const numeroFacturaInput = document.getElementById('numeroFactura');
            if (numeroFacturaInput) {
                // Obtener facturas existentes
                let facturasExistentes = [];
                const facturasGuardadas = localStorage.getItem('facturas');
                if (facturasGuardadas) {
                    try {
                        facturasExistentes = JSON.parse(facturasGuardadas);
                        if (!Array.isArray(facturasExistentes)) {
                            facturasExistentes = [];
                        }
                    } catch (e) {
                        console.error('Error al parsear facturas existentes:', e);
                        facturasExistentes = [];
                    }
                }
                
                // Generar número de factura secuencial con 5 dígitos
                const siguienteNumero = facturasExistentes.length + 1;
                const numeroFormateado = 'FCM-' + String(siguienteNumero).padStart(5, '0');
                
                // Establecer el número de factura en el campo
                numeroFacturaInput.value = numeroFormateado;
                console.log('Número de factura generado:', numeroFormateado);
            }
            
            console.log('=== FIN mostrarFacturaSimple() ===');
            
            // Asegurarse de que el modal sea visible
            setTimeout(() => {
                const modal = document.getElementById('facturaSimpleModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.remove('hidden');
                }
            }, 100);
        }
        
        // Función para cerrar el modal de factura
        window.cerrarFacturaSimple = function() {
            console.log('Cerrando modal de factura...');
            const modal = document.getElementById('facturaSimpleModal');
            if (modal) {
                // Animación de salida
                modal.querySelector('div').classList.remove('opacity-100', 'scale-100');
                modal.querySelector('div').classList.add('opacity-0', 'scale-95');
                
                // Ocultar después de la animación
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    console.log('Modal de factura cerrado');
                }, 200);
            } else {
                console.error('No se encontró el modal de factura para cerrar');
            }
        }

        // Función para mostrar los productos seleccionados en un modal
        function verProductosSeleccionados() {
            const filasProductos = document.querySelectorAll('#tablaProductos tr[data-producto-id]');
            
            if (filasProductos.length === 0) {
                alert('No hay productos seleccionados');
                return;
            }
            
            // Crear el contenido del modal
            let contenidoHTML = `
                <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
                    <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-boxes mr-2"></i>
                            Productos Seleccionados
                        </h3>
                        <button type="button" onclick="cerrarModalSeleccionados()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4 overflow-y-auto">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
            `;

            // Agregar cada producto a la tabla
            filasProductos.forEach(fila => {
                const codigo = fila.querySelector('td:nth-child(1)').textContent;
                const nombre = fila.querySelector('td:nth-child(2)').textContent;
                const cantidad = fila.querySelector('input[data-type="quantity"]').value;
                const precio = fila.querySelector('input[data-type="price"]').value;
                const subtotal = (parseFloat(cantidad) * parseFloat(precio)).toFixed(2);
                
                contenidoHTML += `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${codigo}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${nombre}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${cantidad}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">$${parseFloat(precio).toFixed(2)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">$${subtotal}</td>
                    </tr>
                `;
            });

            // Cerrar la tabla y el modal
            contenidoHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-4 border-t flex justify-end">
                        <button type="button" onclick="cerrarModalSeleccionados()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;

            // Crear y mostrar el modal
            const modal = document.createElement('div');
            modal.id = 'modalProductosSeleccionados';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = contenidoHTML;
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // Función para cerrar el modal de productos seleccionados
        function cerrarModalSeleccionados() {
            const modal = document.getElementById('modalProductosSeleccionados');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        // Función para guardar la factura
        function guardarFactura() {
            console.log('=== GUARDAR FACTURA ===');
            
            // Obtener datos de la factura
            const factura = {
                id: Date.now(),
                numeroFactura: document.getElementById('numeroFactura').value,
                fecha: document.getElementById('fechaFacturaInput').value,
                proveedor: {
                    id: document.getElementById('proveedorFactura').value,
                    nombre: document.getElementById('proveedorFactura').selectedOptions[0]?.textContent || 'Sin proveedor'
                },
                productos: window.productosSeleccionados || [],
                subtotal: parseFloat(document.getElementById('subtotal')?.textContent.replace(/[^0-9.-]+/g,"") || 0),
                iva: parseFloat(document.getElementById('iva')?.textContent.replace(/[^0-9.-]+/g,"") || 0),
                total: parseFloat(document.getElementById('total')?.textContent.replace(/[^0-9.-]+/g,"") || 0),
                estado: 'Pendiente'
            };
            
            // Validar campos requeridos
            if (!factura.numeroFactura || !factura.fecha || !factura.proveedor.id) {
                console.error('Faltan campos requeridos en la factura:', factura);
                alert('Por favor complete todos los campos requeridos');
                return false;
            }
            
            try {
                // Obtener facturas existentes
                let facturasExistentes = [];
                const facturasGuardadas = localStorage.getItem('facturas');
                
                if (facturasGuardadas) {
                    facturasExistentes = JSON.parse(facturasGuardadas);
                    if (!Array.isArray(facturasExistentes)) {
                        facturasExistentes = [];
                    }
                }
                
                // Verificar si ya existe una factura con el mismo ID
                const indiceExistente = facturasExistentes.findIndex(f => f.id === factura.id);
                
                if (indiceExistente >= 0) {
                    // Actualizar factura existente
                    facturasExistentes[indiceExistente] = factura;
                } else {
                    // Agregar nueva factura
                    facturasExistentes.push(factura);
                }
                
                // Guardar en localStorage
                localStorage.setItem('facturas', JSON.stringify(facturasExistentes));
                console.log('Factura guardada correctamente:', factura);
                
                // Actualizar la lista de facturas en la interfaz
                actualizarListaFacturas();
                
                // Cerrar el modal
                const modal = document.getElementById('facturaSimpleModal');
                if (modal) modal.classList.add('hidden');
                
                return true;
            } catch (error) {
                console.error('Error al guardar la factura:', error);
                alert('Ocurrió un error al guardar la factura: ' + error.message);
                return false;
            }
        }
        
        // Cargar facturas desde localStorage
        function cargarFacturas() {
            try {
                const facturasGuardadas = localStorage.getItem('facturas');
                return facturasGuardadas ? JSON.parse(facturasGuardadas) : [];
            } catch (error) {
                console.error('Error al cargar facturas:', error);
                return [];
            }
        }
        
        // Formatear fecha para mostrar
        function formatearFecha(fechaISO) {
            if (!fechaISO) return 'Sin fecha';
            const opciones = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(fechaISO).toLocaleDateString('es-MX', opciones);
        }
        
        // Formatear moneda
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2
            }).format(valor);
        }
        
        // Actualizar la lista de facturas en la interfaz
        function actualizarListaFacturas() {
            const tbody = document.getElementById('listaFacturas');
            if (!tbody) {
                console.error('No se encontró el elemento con ID listaFacturas');
                return;
            }
            
            const facturas = cargarFacturas();
            console.log('Facturas cargadas:', facturas);
            
            if (!facturas || facturas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-file-invoice text-4xl text-gray-300 mb-2"></i>
                                <h3 class="text-lg font-medium text-gray-500">No hay facturas registradas</h3>
                                <p class="text-sm text-gray-400 mt-1">Comienza creando tu primera factura</p>
                                <button onclick="mostrarFacturaSimple()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Crear Factura</span>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                return;
            }
            
            // Ordenar facturas por fecha (más recientes primero)
            facturas.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            // Generar filas de la tabla
            tbody.innerHTML = facturas.map(factura => {
                const estadoClass = {
                    'Pendiente': 'bg-yellow-100 text-yellow-800',
                    'Pagada': 'bg-green-100 text-green-800',
                    'Cancelada': 'bg-red-100 text-red-800'
                }[factura.estado] || 'bg-gray-100 text-gray-800';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${factura.numeroFactura || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${factura.proveedor?.nombre || 'Proveedor no especificado'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatearFecha(factura.fecha)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">
                            ${formatearMoneda(factura.total)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estadoClass}">
                                ${factura.estado || 'Pendiente'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="verDetalleFactura('${factura.id}')" class="text-blue-600 hover:text-blue-900 mr-3" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editarFactura('${factura.id}')" class="text-yellow-600 hover:text-yellow-900 mr-3" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="eliminarFactura('${factura.id}')" class="text-red-600 hover:text-red-900" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            }).join('');
        }
        
        // Función para ver el detalle de una factura
        function verDetalleFactura(id) {
            const facturas = cargarFacturas();
            const factura = facturas.find(f => f.id === id);
            
            if (!factura) {
                alert('No se encontró la factura solicitada');
                return;
            }
            
            // Crear el contenido del modal de detalle
            let productosHTML = '';
            factura.productos.forEach(prod => {
                productosHTML += `
                    <tr class="border-b">
                        <td class="py-2 px-4">${prod.nombre || 'Producto sin nombre'}</td>
                        <td class="py-2 px-4 text-right">${prod.cantidad || 0}</td>
                        <td class="py-2 px-4 text-right">${formatearMoneda(prod.precio || 0)}</td>
                        <td class="py-2 px-4 text-right font-medium">${formatearMoneda(prod.subtotal || 0)}</td>
                    </tr>`;
            });
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Factura: ${factura.numeroFactura || 'N/A'}</h3>
                                    <p class="text-sm text-gray-500">${formatearFecha(factura.fecha)}</p>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium text-gray-700">Proveedor</h4>
                                    <p class="mt-1">${factura.proveedor?.nombre || 'No especificado'}</p>
                                    ${factura.proveedor?.rfc ? `<p class="text-sm text-gray-500">RFC: ${factura.proveedor.rfc}</p>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Subtotal:</span>
                                        <span class="font-medium">${formatearMoneda(factura.subtotal)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">IVA (${factura.aplicarIva ? '16%' : '0%'}):</span>
                                        <span class="font-medium">${formatearMoneda(factura.iva)}</span>
                                    </div>
                                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-200">
                                        <span class="font-semibold">Total:</span>
                                        <span class="font-bold text-lg">${formatearMoneda(factura.total)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8">
                                <h4 class="font-medium text-gray-700 mb-2">Productos</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Precio Unitario</th>
                                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${productosHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    Cerrar
                                </button>
                                <button onclick="imprimirFactura('${factura.id}')" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="fas fa-print mr-2"></i>Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Agregar el modal al documento
            const div = document.createElement('div');
            div.innerHTML = modalHTML;
            document.body.appendChild(div.firstChild);
        }
        
        // Función para imprimir factura
        function imprimirFactura(id) {
            // Implementar lógica de impresión
            alert(`Imprimiendo factura ${id}...`);
        }
        
        // Función para editar factura
        function editarFactura(id) {
            // Implementar lógica de edición
            alert(`Editando factura ${id}...`);
        }
        
        // Función para eliminar factura
        function eliminarFactura(id) {
            if (confirm('¿Está seguro de que desea eliminar esta factura? Esta acción no se puede deshacer.')) {
                const facturas = cargarFacturas();
                const nuevasFacturas = facturas.filter(f => f.id !== id);
                
                try {
                    localStorage.setItem('facturas', JSON.stringify(nuevasFacturas));
                    actualizarListaFacturas();
                    alert('Factura eliminada correctamente');
                } catch (error) {
                    console.error('Error al eliminar la factura:', error);
                    alert('Error al eliminar la factura');
                }
            }
        }
        
        // Cargar proveedores desde localStorage
        function cargarProveedores() {
            try {
                const proveedoresGuardados = localStorage.getItem('proveedores');
                return proveedoresGuardados ? JSON.parse(proveedoresGuardados) : [];
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
                return [];
            }
        }
        
        // Cargar proveedores en el selector
        function cargarSelectProveedores() {
            const selectProveedor = document.getElementById('proveedorFactura');
            if (!selectProveedor) {
                console.error('No se encontró el elemento con ID proveedorFactura');
                return false;
            }
            
            const proveedores = cargarProveedores();
            console.log('Proveedores cargados:', proveedores);
            
            // Limpiar opciones excepto la primera
            while (selectProveedor.options.length > 1) {
                selectProveedor.remove(1);
            }
            
            if (proveedores.length === 0) {
                console.warn('No hay proveedores registrados');
                return false;
            }
            
            // Agregar proveedores al selector
            proveedores.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor.id;
                option.textContent = `${proveedor.nombre}${proveedor.rfc ? ' (' + proveedor.rfc + ')' : ''}`;
                option.dataset.rfc = proveedor.rfc || '';
                option.dataset.telefono = proveedor.telefono || '';
                option.dataset.email = proveedor.email || '';
                option.dataset.direccion = proveedor.direccion || '';
                selectProveedor.appendChild(option);
            });
            
            console.log('Proveedores cargados en el selector');
            return true;
        }
        
        // Mostrar modal para nuevo proveedor
        // Inicializar el módulo de compras
        function inicializarModuloCompras() {
            console.log('Inicializando módulo de compras...');
            
            // Configurar el botón de agregar producto
            const configurarBotonAgregar = () => {
                const btnAgregarProducto = document.getElementById('btnAgregarProducto');
                if (btnAgregarProducto) {
                    // Clonar el botón para limpiar cualquier evento existente
                    const newBtn = btnAgregarProducto.cloneNode(true);
                    btnAgregarProducto.parentNode.replaceChild(newBtn, btnAgregarProducto);
                    
                    // Agregar el manejador de eventos al nuevo botón
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Botón Agregar Producto clickeado');
                        
                        // Verificar si la función existe antes de llamarla
                        if (typeof window.mostrarSeleccionProductos === 'function') {
                            window.mostrarSeleccionProductos();
                        } else {
                            console.error('La función mostrarSeleccionProductos no está definida');
                            alert('Error: No se pudo abrir el selector de productos. Por favor, recargue la página.');
                        }
                    });
                    
                    console.log('Botón Agregar Producto configurado correctamente');
                    return true;
                } else {
                    console.warn('No se encontró el botón de Agregar Producto');
                    return false;
                }
            };
            
            // Configurar el botón de agregar producto
            let intentos = 0;
            const maxIntentos = 5;
            const intervalo = setInterval(() => {
                if (configurarBotonAgregar() || intentos >= maxIntentos) {
                    clearInterval(intervalo);
                    if (intentos >= maxIntentos) {
                        console.error('No se pudo configurar el botón después de varios intentos');
                    }
                }
                intentos++;
            }, 300); // Intentar cada 300ms hasta que se configure o se alcance el máximo de intentos
            
            // Inicializar otros eventos
            inicializarEventosModalProductos();
            
            console.log('Módulo de compras inicializado correctamente');
        }
{{ ... }}
            console.log('DOM fully loaded, initializing application...');

            // Forzar un inicio completamente en blanco para todo el módulo de compras
            localStorage.removeItem('purchaseOrders'); // Elimina órdenes de compra de prueba
            localStorage.setItem('facturas', JSON.stringify([])); // Asegura que no haya facturas
            console.log('Módulo de compras completamente limpio. No se cargarán datos de prueba.');
            
            // Initialize event listeners for the invoice form
            initInvoiceForm();
            
            // Cargar proveedores en el selector
            const proveedoresCargados = cargarSelectProveedores();
            
            // Si no hay proveedores, mostrar un mensaje
            if (!proveedoresCargados) {
                console.warn('No se pudieron cargar los proveedores o no hay proveedores registrados');
            }
            
            // Cargar lista de facturas (estará vacía inicialmente)
            actualizarListaFacturas();
            
            // Check if database is available
            if (typeof window.db === 'undefined') {
                console.error('Database is not initialized. Make sure database.js is loaded correctly.');
                return;
            }
            
            console.log('Database initialized successfully');
            
            // Check if we have products
            const productos = window.db.getProductos ? window.db.getProductos() : [];
            console.log('Products in database:', productos);
            
            // Se ha eliminado la inicialización de datos de prueba para asegurar que el módulo comience vacío.
        });
    </script>

    <script>
        // ====================================
// FUNCIONES DE PROVEEDORES
// ====================================

// Cargar proveedores desde localStorage
function cargarProveedores() {
    const proveedores = JSON.parse(localStorage.getItem('proveedores')) || [];
    console.log('Proveedores cargados:', proveedores);
    return proveedores;
}

// Guardar proveedores en localStorage
function guardarProveedores(proveedores) {
    localStorage.setItem('proveedores', JSON.stringify(proveedores));
    console.log('Proveedores guardados:', proveedores);
}

// Agregar un nuevo proveedor
function agregarProveedor(proveedor) {
    const proveedores = cargarProveedores();
    proveedor.id = Date.now().toString(); // ID único basado en timestamp
    proveedores.push(proveedor);
    guardarProveedores(proveedores);
    return proveedor;
}

// Actualizar el selector de proveedores
function actualizarSelectorProveedores() {
    const selectProveedor = document.getElementById('selectProveedor');
    if (!selectProveedor) return;
    
    // Guardar el valor seleccionado actual
    const proveedorSeleccionado = selectProveedor.value;
    
    // Limpiar opciones
    selectProveedor.innerHTML = '<option value="">Seleccione un proveedor</option>';
    
    // Cargar proveedores
    const proveedores = cargarProveedores();
    
    // Agregar proveedores al selector
    proveedores.forEach(proveedor => {
        const option = document.createElement('option');
        option.value = proveedor.id;
        option.textContent = `${proveedor.nombre} (${proveedor.rif || 'Sin RIF'})`;
        option.dataset.rif = proveedor.rif || '';
        option.dataset.telefono = proveedor.telefono || '';
        option.dataset.email = proveedor.email || '';
        option.dataset.direccion = proveedor.direccion || '';
        selectProveedor.appendChild(option);
    });
    
    // Restaurar la selección anterior si existe
    if (proveedorSeleccionado) {
        selectProveedor.value = proveedorSeleccionado;
    }
}

// ====================================
// FUNCIONES DE INVENTARIO
// ====================================

// Cargar inventario desde localStorage
function cargarInventario() {
    return JSON.parse(localStorage.getItem('inventario')) || [];
}

// Guardar inventario en localStorage
function guardarInventario(inventario) {
    localStorage.setItem('inventario', JSON.stringify(inventario));
}

// Actualizar el inventario cuando se realiza una compra
function actualizarInventario(productosComprados) {
    let inventario = cargarInventario();
    
    productosComprados.forEach(productoCompra => {
        const productoExistente = inventario.find(p => p.id === productoCompra.id);
        
        if (productoExistente) {
            // Actualizar cantidad existente
            productoExistente.cantidad = (parseFloat(productoExistente.cantidad) || 0) + 
                                       (parseFloat(productoCompra.cantidad) || 0);
            productoExistente.precio_compra = productoCompra.precio_compra;
            productoExistente.ultima_actualizacion = new Date().toISOString();
        } else {
            // Agregar nuevo producto al inventario
            inventario.push({
                id: productoCompra.id,
                codigo: productoCompra.codigo,
                nombre: productoCompra.nombre,
                descripcion: productoCompra.descripcion || '',
                cantidad: parseFloat(productoCompra.cantidad) || 0,
                precio_compra: parseFloat(productoCompra.precio_compra) || 0,
                precio_venta: parseFloat(productoCompra.precio_venta) || 0,
                categoria: productoCompra.categoria || 'General',
                fecha_ingreso: new Date().toISOString(),
                ultima_actualizacion: new Date().toISOString()
            });
        }
    });
    
    guardarInventario(inventario);
    console.log('Inventario actualizado:', inventario);
    return inventario;
}

// ====================================
// FUNCIONES DE COMPRAS
// ====================================

// ====================================
// FUNCIONES DE FACTURACIÓN DE COMPRAS
// ====================================

// Obtener los productos seleccionados en la factura
function obtenerProductosFactura() {
    const productos = [];
    const filas = document.querySelectorAll('#tablaProductos tbody tr');
    
    filas.forEach(fila => {
        const producto = {
            id: fila.dataset.id,
            codigo: fila.cells[0].textContent,
            nombre: fila.cells[1].textContent,
            cantidad: parseFloat(fila.cells[2].textContent) || 1,
            precio_compra: parseFloat(fila.cells[3].textContent.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0,
            precio_venta: parseFloat(fila.cells[4].textContent.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0,
            subtotal: parseFloat(fila.cells[5].textContent.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0
        };
        productos.push(producto);
    });
    
    return productos;
}

// Calcular totales de la factura
function calcularTotales() {
    const productos = obtenerProductosFactura();
    const subtotal = productos.reduce((sum, prod) => sum + (prod.cantidad * prod.precio_compra), 0);
    const iva = subtotal * 0.16; // 16% de IVA
    const total = subtotal + iva;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('iva').textContent = iva.toFixed(2);
    document.getElementById('total').textContent = total.toFixed(2);
    
    return { subtotal, iva, total };
}

// Guardar factura de compra
function guardarFacturaCompra() {
    const proveedorId = document.getElementById('selectProveedor').value;
    const numeroFactura = document.getElementById('numeroFactura').value;
    const fechaFactura = document.getElementById('fechaFactura').value;
    const productos = obtenerProductosFactura();
    const { subtotal, iva, total } = calcularTotales();
    
    if (!proveedorId) {
        alert('Por favor seleccione un proveedor');
        return;
    }
    
    if (productos.length === 0) {
        alert('Debe agregar al menos un producto a la factura');
        return;
    }
    
    // Obtener facturas existentes
    const facturas = JSON.parse(localStorage.getItem('facturasCompra')) || [];
    
    // Crear nueva factura
    const nuevaFactura = {
        id: 'FC-' + Date.now(),
        proveedorId,
        numero: numeroFactura,
        fecha: fechaFactura || new Date().toISOString().split('T')[0],
        productos,
        subtotal,
        iva,
        total,
        estado: 'pendiente',
        fechaCreacion: new Date().toISOString()
    };
    
    // Agregar a la lista de facturas
    facturas.push(nuevaFactura);
    
    // Guardar en localStorage
    localStorage.setItem('facturasCompra', JSON.stringify(facturas));
    
    // Actualizar inventario
    actualizarInventario(productos);
    
    // Mostrar mensaje de éxito
    alert(`Factura ${nuevaFactura.numero} guardada correctamente`);
    
    // Limpiar formulario
    limpiarFactura();
    
    return nuevaFactura;
}

// Limpiar formulario de factura
function limpiarFactura() {
    // Limpiar tabla de productos
    document.querySelectorAll('#tablaProductos tbody tr').forEach(tr => tr.remove());
    
    // Restablecer totales
    document.getElementById('subtotal').textContent = '0.00';
    document.getElementById('iva').textContent = '0.00';
    document.getElementById('total').textContent = '0.00';
    
    // Generar nuevo número de factura
    generarNumeroFactura();
}

// Generar número de factura automático
function generarNumeroFactura() {
    const fecha = new Date();
    const anio = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    const timestamp = Date.now().toString().slice(-4);
    
    const numeroFactura = `FC-${anio}${mes}${dia}-${timestamp}`;
    document.getElementById('numeroFactura').value = numeroFactura;
    
    return numeroFactura;
}

// ====================================
// INICIALIZACIÓN
// ====================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando módulo de compras...');
    
    // Inicializar selectores
    actualizarSelectorProveedores();
    generarNumeroFactura();
    
    // Configurar fecha actual
    document.getElementById('fechaFactura').value = new Date().toISOString().split('T')[0];
    
    // Configurar eventos
    document.getElementById('btnGuardarFactura')?.addEventListener('click', guardarFacturaCompra);
    document.getElementById('btnNuevaFactura')?.addEventListener('click', limpiarFactura);
    
    console.log('Módulo de compras inicializado');
});

// Función para abrir el selector de productos
function abrirSelectorProductos() {
    console.log('Intentando abrir el selector de productos...');
    
    // Obtener el modal y su contenido
    const modal = document.getElementById('productosModal');
    const modalContent = document.getElementById('modalContent');
    
    if (!modal || !modalContent) {
        console.error('No se encontró el modal de productos o su contenido');
        alert('Error: No se pudo abrir el selector de productos. Por favor, recargue la página.');
        return;
    }
    
    // Mostrar el modal con animación
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 10);
    
    // Cargar productos disponibles
    cargarProductosDisponibles();
    
    // Enfocar el campo de búsqueda
    const buscarProducto = document.getElementById('buscarProducto');
    if (buscarProducto) {
        buscarProducto.focus();
    }
}

// Hacer la función disponible globalmente
if (typeof window.abrirSelectorProductos === 'undefined') {
    window.abrirSelectorProductos = abrirSelectorProductos;
}

// Función para cargar productos disponibles en el modal
function cargarProductosDisponibles(terminoBusqueda = '') {
    const tbody = document.querySelector('#tablaProductosModal tbody');
    if (!tbody) return;
    
    // Limpiar tabla
    tbody.innerHTML = '';
    
    // Obtener productos (en un sistema real, esto vendría de una API)
    const productos = [
        { id: '1', codigo: 'PROD001', nombre: 'Aceite de Motor 10W40', precio_compra: 15.99, precio_venta: 24.99, categoria: 'Lubricantes' },
        { id: '2', codigo: 'PROD002', nombre: 'Filtro de Aire', precio_compra: 8.50, precio_venta: 14.99, categoria: 'Filtros' },
        { id: '3', codigo: 'PROD003', nombre: 'Pastillas de Freno Delanteras', precio_compra: 25.00, precio_venta: 39.99, categoria: 'Frenos' },
        { id: '4', codigo: 'PROD004', nombre: 'Batería 12V 60Ah', precio_compra: 75.00, precio_venta: 119.99, categoria: 'Baterías' },
        { id: '5', codigo: 'PROD005', nombre: 'Líquido de Frenos DOT4', precio_compra: 4.99, precio_venta: 8.99, categoria: 'Líquidos' },
    ];
    
    // Filtrar productos por término de búsqueda
    const productosFiltrados = terminoBusqueda 
        ? productos.filter(p => 
            p.codigo.toLowerCase().includes(terminoBusqueda.toLowerCase()) ||
            p.nombre.toLowerCase().includes(terminoBusqueda.toLowerCase()) ||
            p.categoria.toLowerCase().includes(terminoBusqueda.toLowerCase())
          )
        : productos;
    
    // Mostrar productos en la tabla
    if (productosFiltrados.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="text-center py-4">No se encontraron productos</td>';
        tbody.appendChild(tr);
        return;
    }
    
    productosFiltrados.forEach(producto => {
        const tr = document.createElement('tr');
        tr.dataset.id = producto.id;
        tr.innerHTML = `
            <td class="px-4 py-2">${producto.codigo}</td>
            <td class="px-4 py-2">${producto.nombre}</td>
            <td class="px-4 py-2">${producto.categoria}</td>
            <td class="px-4 py-2">
                <input type="number" min="1" value="1" class="w-20 p-1 border rounded" data-precio="${producto.precio_compra}">
            </td>
            <td class="px-4 py-2">$${producto.precio_compra.toFixed(2)}</td>
            <td class="px-4 py-2">
                <button onclick="agregarProductoAFactura('${producto.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                    Agregar
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Función para agregar un producto a la factura
function agregarProductoAFactura(productoId) {
    const fila = document.querySelector(`#tablaProductosModal tr[data-id="${productoId}"]`);
    if (!fila) return;
    
    const celdas = fila.cells;
    const cantidadInput = fila.querySelector('input[type="number"]');
    const cantidad = parseInt(cantidadInput.value) || 1;
    const precioCompra = parseFloat(cantidadInput.dataset.precio) || 0;
    
    // Calcular subtotal
    const subtotal = cantidad * precioCompra;
    
    // Agregar a la tabla de productos de la factura
    const tbody = document.querySelector('#tablaProductos tbody');
    const tr = document.createElement('tr');
    tr.dataset.id = productoId;
    tr.innerHTML = `
        <td class="px-4 py-2">${celdas[0].textContent}</td>
        <td class="px-4 py-2">${celdas[1].textContent}</td>
        <td class="px-4 py-2">${cantidad}</td>
        <td class="px-4 py-2">$${precioCompra.toFixed(2)}</td>
        <td class="px-4 py-2">$${(precioCompra * 1.3).toFixed(2)}</td>
        <td class="px-4 py-2">$${subtotal.toFixed(2)}</td>
        <td class="px-4 py-2">
            <button onclick="eliminarProductoFactura(this)" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(tr);
    
    // Actualizar totales
    calcularTotales();
    
    // Cerrar el modal
    document.getElementById('productosModal').classList.add('hidden');
}

// Función para eliminar un producto de la factura
function eliminarProductoFactura(boton) {
    const fila = boton.closest('tr');
    if (fila) {
        fila.remove();
        calcularTotales();
    }
}

// Función para buscar productos en el modal
function buscarProductos() {
    const termino = document.getElementById('buscarProducto').value;
    cargarProductosDisponibles(termino);
}

// Función para cerrar el modal de productos
function cerrarModalProductos() {
    const modal = document.getElementById('productosModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

            // Mostrar el modal
            console.log('Mostrando modal...');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            
            // Forzar reflow para asegurar que la transición se aplique
            void modal.offsetWidth;
            
            // Aplicar estilos de animación
            const modalContent = document.getElementById('modalContent');
            if (modalContent) {
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }
            
            // Deshabilitar scroll del body
            document.body.style.overflow = 'hidden';
            
            // Enfocar el campo de búsqueda si existe
            const buscarProducto = document.getElementById('buscarProducto');
            if (buscarProducto) {
                buscarProducto.focus();
            }
            
            console.log('Modal de productos mostrado correctamente');
        }
        
        // Hacer la función disponible globalmente
        window.abrirSelectorProductos = abrirSelectorProductos;
        
        // Configurar el botón cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Configurando botón Agregar Producto...');
            const btnAgregar = document.getElementById('btnAgregarProducto');
            if (btnAgregar) {
                console.log('Botón Agregar Producto encontrado');
                btnAgregar.onclick = abrirSelectorProductos;
            } else {
                console.error('No se encontró el botón Agregar Producto');
            }
        });
    </script>
</body>
</html>

